{"ast":null,"code":"import{useState,useEffect,useReducer,useContext}from\"react\";import api from\"../../services/api\";import{AuthContext}from\"../../context/Auth/AuthContext\";const reducer=(state,action)=>{if(action.type===\"LOAD_WHATSAPPS\"){const whatsApps=action.payload;return[...whatsApps];}if(action.type===\"UPDATE_WHATSAPPS\"){const whatsApp=action.payload;const whatsAppIndex=state.findIndex(s=>s.id===whatsApp.id);if(whatsAppIndex!==-1){state[whatsAppIndex]=whatsApp;return[...state];}else{return[whatsApp,...state];}}if(action.type===\"UPDATE_SESSION\"){const whatsApp=action.payload;const whatsAppIndex=state.findIndex(s=>s.id===whatsApp.id);if(whatsAppIndex!==-1){state[whatsAppIndex].status=whatsApp.status;state[whatsAppIndex].updatedAt=whatsApp.updatedAt;state[whatsAppIndex].qrcode=whatsApp.qrcode;state[whatsAppIndex].retries=whatsApp.retries;return[...state];}else{return[...state];}}if(action.type===\"DELETE_WHATSAPPS\"){const whatsAppId=action.payload;const whatsAppIndex=state.findIndex(s=>s.id===whatsAppId);if(whatsAppIndex!==-1){state.splice(whatsAppIndex,1);}return[...state];}if(action.type===\"RESET\"){return[];}};const useWhatsApps=()=>{const[whatsApps,dispatch]=useReducer(reducer,[]);const[loading,setLoading]=useState(true);const{user,socket}=useContext(AuthContext);// Effect para carregar os dados iniciais\nuseEffect(()=>{setLoading(true);const fetchSession=async()=>{try{const{data}=await api.get(\"/whatsapp/?session=0\");dispatch({type:\"LOAD_WHATSAPPS\",payload:data});setLoading(false);}catch(err){console.error(\"Erro ao carregar WhatsApps:\",err);setLoading(false);}};fetchSession();},[]);// Effect para configurar os listeners do socket\nuseEffect(()=>{// Debug para entender o que está chegando\nconsole.log('useWhatsApps - Debug:',{userId:user===null||user===void 0?void 0:user.id,companyId:user===null||user===void 0?void 0:user.companyId,socket:socket,socketType:typeof socket,hasOnMethod:socket&&typeof socket.on==='function',hasOffMethod:socket&&typeof socket.off==='function'});if(user!==null&&user!==void 0&&user.companyId&&socket&&typeof socket.on==='function'&&typeof socket.off==='function'){const companyId=user.companyId;const onCompanyWhatsapp=data=>{console.log('Recebido evento whatsapp:',data);if(data.action===\"update\"){dispatch({type:\"UPDATE_WHATSAPPS\",payload:data.whatsapp});}if(data.action===\"delete\"){dispatch({type:\"DELETE_WHATSAPPS\",payload:data.whatsappId});}};const onCompanyWhatsappSession=data=>{console.log('Recebido evento whatsapp session:',data);if(data.action===\"update\"){dispatch({type:\"UPDATE_SESSION\",payload:data.session});}};const whatsappEvent=\"company-\".concat(companyId,\"-whatsapp\");const sessionEvent=\"company-\".concat(companyId,\"-whatsappSession\");console.log('Registrando listeners WhatsApp:',{whatsappEvent,sessionEvent});socket.on(whatsappEvent,onCompanyWhatsapp);socket.on(sessionEvent,onCompanyWhatsappSession);return()=>{if(socket&&typeof socket.off==='function'){console.log('Removendo listeners WhatsApp:',{whatsappEvent,sessionEvent});socket.off(whatsappEvent,onCompanyWhatsapp);socket.off(sessionEvent,onCompanyWhatsappSession);}};}else{console.log('Condições não atendidas para listeners WhatsApp:',{hasCompanyId:!!(user!==null&&user!==void 0&&user.companyId),hasSocket:!!socket,hasOnMethod:socket&&typeof socket.on==='function',hasOffMethod:socket&&typeof socket.off==='function'});}},[socket,user===null||user===void 0?void 0:user.companyId]);// Dependências corretas\nreturn{whatsApps,loading};};export default useWhatsApps;","map":{"version":3,"names":["useState","useEffect","useReducer","useContext","api","AuthContext","reducer","state","action","type","whatsApps","payload","whatsApp","whatsAppIndex","findIndex","s","id","status","updatedAt","qrcode","retries","whatsAppId","splice","useWhatsApps","dispatch","loading","setLoading","user","socket","fetchSession","data","get","err","console","error","log","userId","companyId","socketType","hasOnMethod","on","hasOffMethod","off","onCompanyWhatsapp","whatsapp","whatsappId","onCompanyWhatsappSession","session","whatsappEvent","concat","sessionEvent","hasCompanyId","hasSocket"],"sources":["/home/deploy/codigologlow/frontend/src/hooks/useWhatsApps/index.js"],"sourcesContent":["import { useState, useEffect, useReducer, useContext } from \"react\";\nimport api from \"../../services/api\";\nimport { AuthContext } from \"../../context/Auth/AuthContext\";\n\nconst reducer = (state, action) => {\n  if (action.type === \"LOAD_WHATSAPPS\") {\n    const whatsApps = action.payload;\n    return [...whatsApps];\n  }\n\n  if (action.type === \"UPDATE_WHATSAPPS\") {\n    const whatsApp = action.payload;\n    const whatsAppIndex = state.findIndex((s) => s.id === whatsApp.id);\n\n    if (whatsAppIndex !== -1) {\n      state[whatsAppIndex] = whatsApp;\n      return [...state];\n    } else {\n      return [whatsApp, ...state];\n    }\n  }\n\n  if (action.type === \"UPDATE_SESSION\") {\n    const whatsApp = action.payload;\n    const whatsAppIndex = state.findIndex((s) => s.id === whatsApp.id);\n\n    if (whatsAppIndex !== -1) {\n      state[whatsAppIndex].status = whatsApp.status;\n      state[whatsAppIndex].updatedAt = whatsApp.updatedAt;\n      state[whatsAppIndex].qrcode = whatsApp.qrcode;\n      state[whatsAppIndex].retries = whatsApp.retries;\n      return [...state];\n    } else {\n      return [...state];\n    }\n  }\n\n  if (action.type === \"DELETE_WHATSAPPS\") {\n    const whatsAppId = action.payload;\n    const whatsAppIndex = state.findIndex((s) => s.id === whatsAppId);\n    if (whatsAppIndex !== -1) {\n      state.splice(whatsAppIndex, 1);\n    }\n    return [...state];\n  }\n\n  if (action.type === \"RESET\") {\n    return [];\n  }\n};\n\nconst useWhatsApps = () => {\n  const [whatsApps, dispatch] = useReducer(reducer, []);\n  const [loading, setLoading] = useState(true);\n  const { user, socket } = useContext(AuthContext);\n\n  // Effect para carregar os dados iniciais\n  useEffect(() => {\n    setLoading(true);\n    const fetchSession = async () => {\n      try {\n        const { data } = await api.get(\"/whatsapp/?session=0\");\n        dispatch({ type: \"LOAD_WHATSAPPS\", payload: data });\n        setLoading(false);\n      } catch (err) {\n        console.error(\"Erro ao carregar WhatsApps:\", err);\n        setLoading(false);\n      }\n    };\n    fetchSession();\n  }, []);\n\n  // Effect para configurar os listeners do socket\n  useEffect(() => {\n    // Debug para entender o que está chegando\n    console.log('useWhatsApps - Debug:', {\n      userId: user?.id,\n      companyId: user?.companyId,\n      socket: socket,\n      socketType: typeof socket,\n      hasOnMethod: socket && typeof socket.on === 'function',\n      hasOffMethod: socket && typeof socket.off === 'function'\n    });\n\n    if (user?.companyId && socket && typeof socket.on === 'function' && typeof socket.off === 'function') {\n      const companyId = user.companyId;\n      \n      const onCompanyWhatsapp = (data) => {\n        console.log('Recebido evento whatsapp:', data);\n        if (data.action === \"update\") {\n          dispatch({ type: \"UPDATE_WHATSAPPS\", payload: data.whatsapp });\n        }\n        if (data.action === \"delete\") {\n          dispatch({ type: \"DELETE_WHATSAPPS\", payload: data.whatsappId });\n        }\n      };\n\n      const onCompanyWhatsappSession = (data) => {\n        console.log('Recebido evento whatsapp session:', data);\n        if (data.action === \"update\") {\n          dispatch({ type: \"UPDATE_SESSION\", payload: data.session });\n        }\n      };\n\n      const whatsappEvent = `company-${companyId}-whatsapp`;\n      const sessionEvent = `company-${companyId}-whatsappSession`;\n\n      console.log('Registrando listeners WhatsApp:', { whatsappEvent, sessionEvent });\n\n      socket.on(whatsappEvent, onCompanyWhatsapp);\n      socket.on(sessionEvent, onCompanyWhatsappSession);\n\n      return () => {\n        if (socket && typeof socket.off === 'function') {\n          console.log('Removendo listeners WhatsApp:', { whatsappEvent, sessionEvent });\n          socket.off(whatsappEvent, onCompanyWhatsapp);\n          socket.off(sessionEvent, onCompanyWhatsappSession);\n        }\n      };\n    } else {\n      console.log('Condições não atendidas para listeners WhatsApp:', {\n        hasCompanyId: !!user?.companyId,\n        hasSocket: !!socket,\n        hasOnMethod: socket && typeof socket.on === 'function',\n        hasOffMethod: socket && typeof socket.off === 'function'\n      });\n    }\n  }, [socket, user?.companyId]); // Dependências corretas\n\n  return { whatsApps, loading };\n};\n\nexport default useWhatsApps;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}