{"ast":null,"code":"import _objectSpread from\"/home/deploy/atendechatop/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useReducer,useContext}from\"react\";import{makeStyles}from\"@material-ui/core/styles\";import Paper from\"@material-ui/core/Paper\";import Button from\"@material-ui/core/Button\";import Table from\"@material-ui/core/Table\";import TableBody from\"@material-ui/core/TableBody\";import TableCell from\"@material-ui/core/TableCell\";import TableHead from\"@material-ui/core/TableHead\";import TableRow from\"@material-ui/core/TableRow\";import MainContainer from\"../../components/MainContainer\";import MainHeader from\"../../components/MainHeader\";import Title from\"../../components/Title\";import SubscriptionModal from\"../../components/SubscriptionModal\";import api from\"../../services/api\";import TableRowSkeleton from\"../../components/TableRowSkeleton\";import toastError from\"../../errors/toastError\";import{AuthContext}from\"../../context/Auth/AuthContext\";import moment from\"moment\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const reducer=(state,action)=>{if(action.type===\"LOAD_INVOICES\"){const invoices=action.payload.invoices||action.payload;const newInvoices=[];invoices.forEach(invoice=>{const invoiceIndex=state.findIndex(i=>i.id===invoice.id);if(invoiceIndex!==-1){state[invoiceIndex]=invoice;}else{newInvoices.push(invoice);}});return[...state,...newInvoices];}if(action.type===\"UPDATE_INVOICES\"){const invoice=action.payload;const invoiceIndex=state.findIndex(i=>i.id===invoice.id);if(invoiceIndex!==-1){state[invoiceIndex]=invoice;return[...state];}else{return[invoice,...state];}}if(action.type===\"DELETE_INVOICE\"){const invoiceId=action.payload;const invoiceIndex=state.findIndex(i=>i.id===invoiceId);if(invoiceIndex!==-1){state.splice(invoiceIndex,1);}return[...state];}if(action.type===\"RESET\"){return[];}};const useStyles=makeStyles(theme=>({mainPaper:_objectSpread({flex:1,padding:theme.spacing(1),overflowY:\"scroll\"},theme.scrollbarStyles)}));const Invoices=()=>{const classes=useStyles();const{user}=useContext(AuthContext);const[loading,setLoading]=useState(false);const[pageNumber,setPageNumber]=useState(1);const[hasMore,setHasMore]=useState(false);const[searchParam]=useState(\"\");const[invoices,dispatch]=useReducer(reducer,[]);const[storagePlans,setStoragePlans]=React.useState([]);const[selectedContactId,setSelectedContactId]=useState(null);const[contactModalOpen,setContactModalOpen]=useState(false);const[isCompanyExpired,setIsCompanyExpired]=useState(false);// Verificar se a empresa está vencida\nuseEffect(()=>{if(user&&user.company){const hoje=moment();const vencimento=moment(user.company.dueDate);const isExpired=hoje.isAfter(vencimento);setIsCompanyExpired(isExpired);}},[user]);const handleOpenContactModal=invoices=>{setStoragePlans(invoices);setSelectedContactId(null);setContactModalOpen(true);};const handleCloseContactModal=()=>{setSelectedContactId(null);setContactModalOpen(false);};useEffect(()=>{dispatch({type:\"RESET\"});setPageNumber(1);},[searchParam]);useEffect(()=>{setLoading(true);const delayDebounceFn=setTimeout(()=>{const fetchInvoices=async()=>{try{console.log(\"Buscando faturas...\",{searchParam,pageNumber});const{data}=await api.get(\"/invoices/all\",{params:{searchParam,pageNumber}});console.log(\"Dados recebidos:\",data);dispatch({type:\"LOAD_INVOICES\",payload:data});console.log(\"Dispatch realizado com payload:\",data);setHasMore(data.hasMore);setLoading(false);}catch(err){console.error(\"Erro ao buscar faturas:\",err);toastError(err);setLoading(false);}};fetchInvoices();},500);return()=>clearTimeout(delayDebounceFn);},[searchParam,pageNumber]);const loadMore=()=>{setPageNumber(prevState=>prevState+1);};const handleScroll=e=>{if(!hasMore||loading)return;const{scrollTop,scrollHeight,clientHeight}=e.currentTarget;if(scrollHeight-(scrollTop+100)<clientHeight){loadMore();}};const rowStyle=record=>{const hoje=moment(moment()).format(\"DD/MM/yyyy\");const vencimento=moment(record.dueDate).format(\"DD/MM/yyyy\");var diff=moment(vencimento,\"DD/MM/yyyy\").diff(moment(hoje,\"DD/MM/yyyy\"));var dias=moment.duration(diff).asDays();if(dias<0&&record.status!==\"paid\"){return{backgroundColor:\"#ffbcbc9c\"};}};const rowStatus=record=>{const hoje=moment(moment()).format(\"DD/MM/yyyy\");const vencimento=moment(record.dueDate).format(\"DD/MM/yyyy\");var diff=moment(vencimento,\"DD/MM/yyyy\").diff(moment(hoje,\"DD/MM/yyyy\"));var dias=moment.duration(diff).asDays();const status=record.status;if(status===\"paid\"){return\"Pago\";}if(dias<0){return\"Vencido\";}else{return\"Em Aberto\";}};const renderUseWhatsapp=row=>{return row.status===false?\"Não\":\"Sim\";};const renderUseFacebook=row=>{return row.status===false?\"Não\":\"Sim\";};const renderUseInstagram=row=>{return row.status===false?\"Não\":\"Sim\";};const renderUseCampaigns=row=>{return row.status===false?\"Não\":\"Sim\";};const renderUseSchedules=row=>{return row.status===false?\"Não\":\"Sim\";};const renderUseInternalChat=row=>{return row.status===false?\"Não\":\"Sim\";};const renderUseExternalApi=row=>{return row.status===false?\"Não\":\"Sim\";};return/*#__PURE__*/_jsxs(MainContainer,{children:[/*#__PURE__*/_jsx(SubscriptionModal,{open:contactModalOpen,onClose:handleCloseContactModal,\"aria-labelledby\":\"form-dialog-title\",Invoice:storagePlans,contactId:selectedContactId}),/*#__PURE__*/_jsxs(MainHeader,{children:[/*#__PURE__*/_jsxs(Title,{children:[\"Faturas (\",invoices.length,\")\"]}),isCompanyExpired&&/*#__PURE__*/_jsxs(\"div\",{style:{backgroundColor:'#ffebee',color:'#c62828',padding:'10px',borderRadius:'4px',marginTop:'10px',border:'1px solid #ef9a9a'},children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Aten\\xE7\\xE3o:\"}),\" Sua assinatura est\\xE1 vencida. Entre em contato com o suporte para regularizar sua situa\\xE7\\xE3o.\"]})]}),/*#__PURE__*/_jsx(Paper,{className:classes.mainPaper,variant:\"outlined\",onScroll:handleScroll,children:/*#__PURE__*/_jsxs(Table,{size:\"small\",children:[/*#__PURE__*/_jsx(TableHead,{children:/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Detalhes\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Usu\\xE1rios\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Conex\\xF5es\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Filas\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Valor\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Data Venc.\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Status\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"A\\xE7\\xE3o\"})]})}),/*#__PURE__*/_jsx(TableBody,{children:/*#__PURE__*/_jsxs(_Fragment,{children:[invoices.map(invoices=>/*#__PURE__*/_jsxs(TableRow,{style:rowStyle(invoices),children:[/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:invoices.detail}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:invoices.users}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:invoices.connections}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:invoices.queues}),/*#__PURE__*/_jsx(TableCell,{style:{fontWeight:'bold'},align:\"center\",children:invoices.value.toLocaleString('pt-br',{style:'currency',currency:'BRL'})}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:moment(invoices.dueDate).format(\"DD/MM/YYYY\")}),/*#__PURE__*/_jsx(TableCell,{style:{fontWeight:'bold'},align:\"center\",children:rowStatus(invoices)}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:rowStatus(invoices)!==\"Pago\"?/*#__PURE__*/_jsx(Button,{size:\"small\",variant:\"outlined\",color:\"secondary\",onClick:()=>handleOpenContactModal(invoices),children:\"PAGAR\"}):/*#__PURE__*/_jsx(Button,{size:\"small\",variant:\"outlined\"// color=\"secondary\"\n,children:\"PAGO\"})})]},invoices.id)),loading&&/*#__PURE__*/_jsx(TableRowSkeleton,{columns:4})]})})]})})]});};export default Invoices;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}