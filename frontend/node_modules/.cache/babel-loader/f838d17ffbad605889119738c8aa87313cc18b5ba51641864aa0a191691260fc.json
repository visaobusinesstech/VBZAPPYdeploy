{"ast":null,"code":"import _objectSpread from\"/home/deploy/codigologlow/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useContext,useEffect,useReducer,useRef,useState}from\"react\";import{makeStyles}from\"@material-ui/core/styles\";import toastError from\"../../errors/toastError\";import Popover from\"@material-ui/core/Popover\";import{MdOutlineForum}from\"react-icons/md\";import{Badge,IconButton,List,ListItem,ListItemText,Paper,Typography,MenuItem,DialogTitle,DialogContent,DialogActions,Button,TextField}from\"@material-ui/core\";import api from\"../../services/api\";import{isArray}from\"lodash\";import{useDate}from\"../../hooks/useDate\";import{AuthContext}from\"../../context/Auth/AuthContext\";import notifySound from\"../../assets/chat_notify.mp3\";import useSound from\"use-sound\";import{i18n}from\"../../translate/i18n\";import{useHistory}from\"react-router-dom\";import{format}from\"date-fns\";import{socketConnection}from\"../../services/socket\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const useStyles=makeStyles(theme=>({mainPaper:_objectSpread({flex:1,maxHeight:300,maxWidth:500,padding:theme.spacing(1),overflowY:\"scroll\"},theme.scrollbarStyles)}));const reducer=(state,action)=>{if(action.type===\"LOAD_CHATS\"){const chats=action.payload;const newChats=[];if(isArray(chats)){chats.forEach(chat=>{const chatIndex=state.findIndex(u=>u.id===chat.id);if(chatIndex!==-1){state[chatIndex]=chat;}else{newChats.push(chat);}});}return[...state,...newChats];}if(action.type===\"UPDATE_CHATS\"){const chat=action.payload;const chatIndex=state.findIndex(u=>u.id===chat.id);if(chatIndex!==-1){state[chatIndex]=chat;return[...state];}else{return[chat,...state];}}if(action.type===\"DELETE_CHAT\"){const chatId=action.payload;const chatIndex=state.findIndex(u=>u.id===chatId);if(chatIndex!==-1){state.splice(chatIndex,1);}return[...state];}if(action.type===\"RESET\"){return[];}if(action.type===\"CHANGE_CHAT\"){const changedChats=state.map(chat=>{if(chat.id===action.payload.chat.id){return action.payload.chat;}return chat;});return changedChats;}};export default function ChatPopover(volume){const classes=useStyles();//   const socketManager = useContext(SocketContext);\nconst{user:loggedUser,socket}=useContext(AuthContext);const history=useHistory();const historyRef=useRef(history);const[loading,setLoading]=useState(false);const[anchorEl,setAnchorEl]=useState(null);const[pageNumber,setPageNumber]=useState(1);const[hasMore,setHasMore]=useState(false);const[searchParam]=useState(\"\");const[chats,dispatch]=useReducer(reducer,[]);const[invisible,setInvisible]=useState(true);const{datetimeToClient}=useDate();const[play]=useSound(notifySound,volume);const soundAlertRef=useRef();useEffect(()=>{soundAlertRef.current=play;if(!(\"Notification\"in window)){console.log(\"This browser doesn't support notifications\");}else{Notification.requestPermission();}},[play]);useEffect(()=>{dispatch({type:\"RESET\"});setPageNumber(1);},[searchParam]);useEffect(()=>{setLoading(true);const delayDebounceFn=setTimeout(()=>{fetchChats();},500);return()=>clearTimeout(delayDebounceFn);// eslint-disable-next-line react-hooks/exhaustive-deps\n},[searchParam,pageNumber]);useEffect(()=>{if(loggedUser.id){const companyId=loggedUser.companyId;const socket=socketConnection({companyId,userId:loggedUser.id});const onCompanyChatPopover=data=>{if(data.action===\"new-message\"){dispatch({type:\"CHANGE_CHAT\",payload:data});console.log(data);if(data.newMessage.senderId!==loggedUser.id&&data.chat.users.find(user=>user.userId===loggedUser.id)){soundAlertRef.current();// Check if notifications are permitted\nif(Notification.permission===\"granted\"){const notification=new Notification(\"Chat interno nÂº \"+data.newMessage.chatId,{body:\"\".concat(data.newMessage.sender.name,\": \").concat(data.newMessage.message,\" - \").concat(format(new Date(),\"HH:mm\")),icon:data.newMessage.sender.profileImage});notification.onclick=e=>{e.preventDefault();window.focus();historyRef.current.push(\"/chats/\".concat(data.newMessage.chatId));};}}}if(data.action===\"update\"){dispatch({type:\"CHANGE_CHAT\",payload:data});}};socket.on(\"company-\".concat(companyId,\"-chat\"),onCompanyChatPopover);return()=>{socket.off(\"company-\".concat(companyId,\"-chat\"),onCompanyChatPopover);};}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[loggedUser.id,loggedUser.companyId]);useEffect(()=>{let unreadsCount=0;if(chats.length>0){for(let chat of chats){for(let chatUser of chat.users){if(chatUser.userId===loggedUser.id){unreadsCount+=chatUser.unreads;}}}}if(unreadsCount>0){setInvisible(false);}else{setInvisible(true);}},[chats,loggedUser.id]);const fetchChats=async()=>{try{const{data}=await api.get(\"/chats/\",{params:{searchParam,pageNumber}});dispatch({type:\"LOAD_CHATS\",payload:data.records});setHasMore(data.hasMore);setLoading(false);}catch(err){toastError(err);}};const loadMore=()=>{setPageNumber(prevState=>prevState+1);};const handleScroll=e=>{if(!hasMore||loading)return;const{scrollTop,scrollHeight,clientHeight}=e.currentTarget;if(scrollHeight-(scrollTop+100)<clientHeight){loadMore();}};const handleClick=event=>{setAnchorEl(event.currentTarget);setInvisible(true);};const handleClose=()=>{setAnchorEl(null);};const goToMessages=chat=>{window.location.href=\"/chats/\".concat(chat.uuid);};const open=Boolean(anchorEl);const id=open?\"simple-popover\":undefined;return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(IconButton,{\"aria-describedby\":id,variant:\"contained\",color:invisible?\"default\":\"inherit\",onClick:handleClick,style:{color:\"white\"},size:\"large\",children:/*#__PURE__*/_jsx(Badge,{color:\"secondary\",variant:\"dot\",invisible:invisible,children:/*#__PURE__*/_jsx(MdOutlineForum,{size:18})})}),/*#__PURE__*/_jsx(Popover,{id:id,open:open,anchorEl:anchorEl,onClose:handleClose,anchorOrigin:{vertical:\"bottom\",horizontal:\"center\"},transformOrigin:{vertical:\"top\",horizontal:\"center\"},children:/*#__PURE__*/_jsx(Paper,{variant:\"outlined\",onScroll:handleScroll,className:classes.mainPaper,children:/*#__PURE__*/_jsxs(List,{component:\"nav\",\"aria-label\":\"main mailbox folders\",style:{minWidth:300},children:[isArray(chats)&&chats.map((item,key)=>{var _item$lastMessage,_item$lastMessage$sen,_item$lastMessage2;return/*#__PURE__*/_jsx(ListItem,{style:{background:key%2===0?\"#ededed\":\"white\",border:\"1px solid #eee\",cursor:\"pointer\"},onClick:()=>goToMessages(item),button:true,children:/*#__PURE__*/_jsx(ListItemText,{primary:/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",flexDirection:\"column\"},children:[/*#__PURE__*/_jsx(Typography,{component:\"span\",style:{fontWeight:\"bold\",fontSize:13},children:typeof item.lastMessage===\"string\"?item.title||\"Chat\":((_item$lastMessage=item.lastMessage)===null||_item$lastMessage===void 0?void 0:(_item$lastMessage$sen=_item$lastMessage.sender)===null||_item$lastMessage$sen===void 0?void 0:_item$lastMessage$sen.name)||item.title||\"Chat\"}),/*#__PURE__*/_jsx(Typography,{component:\"span\",style:{fontSize:12,color:\"#666\"},children:typeof item.lastMessage===\"string\"?item.lastMessage:((_item$lastMessage2=item.lastMessage)===null||_item$lastMessage2===void 0?void 0:_item$lastMessage2.message)||\"Nenhuma mensagem\"})]}),secondary:/*#__PURE__*/_jsx(Typography,{component:\"span\",style:{fontSize:12},children:datetimeToClient(item.updatedAt)})})},key);}),isArray(chats)&&chats.length===0&&/*#__PURE__*/_jsx(ListItemText,{primary:i18n.t(\"mainDrawer.appBar.notRegister\")})]})})})]});}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}