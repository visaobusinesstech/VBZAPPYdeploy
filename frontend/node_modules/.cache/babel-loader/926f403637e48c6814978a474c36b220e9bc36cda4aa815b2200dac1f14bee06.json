{"ast":null,"code":"import _objectSpread from\"/home/deploy/codigologlow/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";/* eslint-disable no-unused-vars */import React,{useState,useEffect,useReducer,useContext}from\"react\";import{toast}from\"react-toastify\";import{useHistory}from\"react-router-dom\";import{makeStyles}from\"@material-ui/core/styles\";import Paper from\"@material-ui/core/Paper\";import Button from\"@material-ui/core/Button\";import Table from\"@material-ui/core/Table\";import TableBody from\"@material-ui/core/TableBody\";import TableCell from\"@material-ui/core/TableCell\";import TableHead from\"@material-ui/core/TableHead\";import TableRow from\"@material-ui/core/TableRow\";import IconButton from\"@material-ui/core/IconButton\";import SearchIcon from\"@material-ui/icons/Search\";import TextField from\"@material-ui/core/TextField\";import InputAdornment from\"@material-ui/core/InputAdornment\";import Tooltip from\"@material-ui/core/Tooltip\";import Chip from\"@material-ui/core/Chip\";import DeleteOutlineIcon from\"@material-ui/icons/DeleteOutline\";import EditIcon from\"@material-ui/icons/Edit\";import DescriptionIcon from\"@material-ui/icons/Description\";import PlayCircleOutlineIcon from\"@material-ui/icons/PlayCircleOutline\";import PauseCircleOutlineIcon from\"@material-ui/icons/PauseCircleOutline\";import RepeatIcon from\"@material-ui/icons/Repeat\";import StopIcon from\"@material-ui/icons/Stop\";import ScheduleIcon from\"@material-ui/icons/Schedule\";import MainContainer from\"../../components/MainContainer\";import MainHeader from\"../../components/MainHeader\";import Title from\"../../components/Title\";import api from\"../../services/api\";import{i18n}from\"../../translate/i18n\";import TableRowSkeleton from\"../../components/TableRowSkeleton\";import CampaignModal from\"../../components/CampaignModal\";import ConfirmationModal from\"../../components/ConfirmationModal\";import toastError from\"../../errors/toastError\";import{Grid,FormControl,InputLabel,Select,MenuItem,TablePagination,Pagination,Box}from\"@material-ui/core\";import{isArray}from\"lodash\";import{useDate}from\"../../hooks/useDate\";import ForbiddenPage from\"../../components/ForbiddenPage\";import usePlans from\"../../hooks/usePlans\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const reducer=(state,action)=>{if(action.type===\"LOAD_CAMPAIGNS\"){const campaigns=action.payload;const newCampaigns=[];if(isArray(campaigns)){campaigns.forEach(campaign=>{const campaignIndex=state.findIndex(u=>u.id===campaign.id);if(campaignIndex!==-1){state[campaignIndex]=campaign;}else{newCampaigns.push(campaign);}});}return[...state,...newCampaigns];}if(action.type===\"UPDATE_CAMPAIGNS\"){const campaign=action.payload;const campaignIndex=state.findIndex(u=>u.id===campaign.id);if(campaignIndex!==-1){state[campaignIndex]=campaign;return[...state];}else{return[campaign,...state];}}if(action.type===\"DELETE_CAMPAIGN\"){const campaignId=action.payload;const campaignIndex=state.findIndex(u=>u.id===campaignId);if(campaignIndex!==-1){state.splice(campaignIndex,1);}return[...state];}if(action.type===\"RESET\"){return[];}};const useStyles=makeStyles(theme=>({mainPaper:_objectSpread({flex:1,padding:theme.padding,overflowY:\"scroll\"},theme.scrollbarStyles),recurringChip:{backgroundColor:theme.palette.primary.main,color:theme.palette.primary.contrastText,fontSize:'0.75rem'},statusChip:{fontSize:'0.75rem'},nextExecutionCell:{fontWeight:500,color:theme.palette.text.secondary},filterContainer:{marginBottom:theme.spacing(2)},tableHeader:{fontWeight:'bold',backgroundColor:theme.palette.grey[100]}}));const Campaigns=()=>{const classes=useStyles();const history=useHistory();const[loading,setLoading]=useState(false);const[pageNumber,setPageNumber]=useState(1);const[pageSize,setPageSize]=useState(10);const[totalPages,setTotalPages]=useState(1);const[totalCount,setTotalCount]=useState(0);const[hasMore,setHasMore]=useState(false);const[selectedCampaign,setSelectedCampaign]=useState(null);const[deletingCampaign,setDeletingCampaign]=useState(null);const[campaignModalOpen,setCampaignModalOpen]=useState(false);const[confirmModalOpen,setConfirmModalOpen]=useState(false);const[stopRecurrenceModalOpen,setStopRecurrenceModalOpen]=useState(false);const[searchParam,setSearchParam]=useState(\"\");const[statusFilter,setStatusFilter]=useState(\"\");const[recurrenceFilter,setRecurrenceFilter]=useState(\"\");const[campaigns,dispatch]=useReducer(reducer,[]);const{user,socket}=useContext(AuthContext);const{datetimeToClient}=useDate();const{getPlanCompany}=usePlans();useEffect(()=>{async function fetchData(){const companyId=user.companyId;const planConfigs=await getPlanCompany(undefined,companyId);if(!planConfigs.plan.useCampaigns){toast.error(\"Esta empresa não possui permissão para acessar essa página! Estamos lhe redirecionando.\");setTimeout(()=>{history.push(\"/\");},1000);}}fetchData();},[]);useEffect(()=>{dispatch({type:\"RESET\"});setPageNumber(1);},[searchParam,statusFilter,recurrenceFilter,pageSize]);useEffect(()=>{setLoading(true);const delayDebounceFn=setTimeout(()=>{fetchCampaigns();},500);return()=>clearTimeout(delayDebounceFn);},[searchParam,pageNumber,statusFilter,recurrenceFilter,pageSize]);useEffect(()=>{const companyId=user.companyId;const onCompanyCampaign=data=>{if(data.action===\"update\"||data.action===\"create\"){dispatch({type:\"UPDATE_CAMPAIGNS\",payload:data.record});}if(data.action===\"delete\"){dispatch({type:\"DELETE_CAMPAIGN\",payload:+data.id});}};socket.on(\"company-\".concat(companyId,\"-campaign\"),onCompanyCampaign);return()=>{socket.off(\"company-\".concat(companyId,\"-campaign\"),onCompanyCampaign);};},[user]);const fetchCampaigns=async()=>{try{const{data}=await api.get(\"/campaigns/\",{params:{searchParam,pageNumber,pageSize,status:statusFilter,isRecurring:recurrenceFilter}});// Para paginação real, substituir os dados em vez de adicionar\nif(pageNumber===1){dispatch({type:\"RESET\"});}dispatch({type:\"LOAD_CAMPAIGNS\",payload:data.records});setHasMore(data.hasMore);setTotalPages(data.totalPages||1);setTotalCount(data.count||0);setLoading(false);}catch(err){toastError(err);}};const handleOpenCampaignModal=()=>{setSelectedCampaign(null);setCampaignModalOpen(true);};const handleCloseCampaignModal=()=>{setSelectedCampaign(null);setCampaignModalOpen(false);};const handleSearch=event=>{setSearchParam(event.target.value.toLowerCase());};const handleStatusFilterChange=event=>{setStatusFilter(event.target.value);};const handleRecurrenceFilterChange=event=>{setRecurrenceFilter(event.target.value);};const handleEditCampaign=campaign=>{setSelectedCampaign(campaign);setCampaignModalOpen(true);};const handleDeleteCampaign=async campaignId=>{try{await api.delete(\"/campaigns/\".concat(campaignId));toast.success(i18n.t(\"campaigns.toasts.deleted\"));}catch(err){toastError(err);}setDeletingCampaign(null);setSearchParam(\"\");setPageNumber(1);};const handleStopRecurrence=async campaignId=>{try{await api.post(\"/campaigns/\".concat(campaignId,\"/stop-recurrence\"));toast.success(\"Recorrência interrompida com sucesso!\");setPageNumber(1);fetchCampaigns();}catch(err){toastError(err);}setStopRecurrenceModalOpen(false);setSelectedCampaign(null);};const handlePageChange=(event,newPage)=>{setPageNumber(newPage+1);// Material-UI usa índice baseado em 0\n};const handlePageSizeChange=event=>{setPageSize(parseInt(event.target.value,10));setPageNumber(1);};const formatStatus=val=>{switch(val){case\"INATIVA\":return\"Inativa\";case\"PROGRAMADA\":return\"Programada\";case\"EM_ANDAMENTO\":return\"Em Andamento\";case\"CANCELADA\":return\"Cancelada\";case\"FINALIZADA\":return\"Finalizada\";default:return val;}};const getStatusColor=status=>{switch(status){case\"INATIVA\":return\"default\";case\"PROGRAMADA\":return\"primary\";case\"EM_ANDAMENTO\":return\"secondary\";case\"CANCELADA\":return\"default\";case\"FINALIZADA\":return\"default\";default:return\"default\";}};const formatRecurrenceType=type=>{switch(type){case\"minutely\":return\"Por Minuto\";case\"hourly\":return\"Por Hora\";case\"daily\":return\"Diário\";case\"weekly\":return\"Semanal\";case\"biweekly\":return\"Quinzenal\";case\"monthly\":return\"Mensal\";case\"yearly\":return\"Anual\";default:return type;}};const cancelCampaign=async campaign=>{try{await api.post(\"/campaigns/\".concat(campaign.id,\"/cancel\"));toast.success(i18n.t(\"campaigns.toasts.cancel\"));setPageNumber(1);fetchCampaigns();}catch(err){toast.error(err.message);}};const restartCampaign=async campaign=>{try{await api.post(\"/campaigns/\".concat(campaign.id,\"/restart\"));toast.success(i18n.t(\"campaigns.toasts.restart\"));setPageNumber(1);fetchCampaigns();}catch(err){toast.error(err.message);}};return/*#__PURE__*/_jsxs(MainContainer,{children:[/*#__PURE__*/_jsx(ConfirmationModal,{title:deletingCampaign&&\"\".concat(i18n.t(\"campaigns.confirmationModal.deleteTitle\"),\" \").concat(deletingCampaign.name,\"?\"),open:confirmModalOpen,onClose:setConfirmModalOpen,onConfirm:()=>handleDeleteCampaign(deletingCampaign.id),children:i18n.t(\"campaigns.confirmationModal.deleteMessage\")}),/*#__PURE__*/_jsx(ConfirmationModal,{title:\"Interromper Recorr\\xEAncia\",open:stopRecurrenceModalOpen,onClose:()=>setStopRecurrenceModalOpen(false),onConfirm:()=>handleStopRecurrence(selectedCampaign===null||selectedCampaign===void 0?void 0:selectedCampaign.id),children:\"Tem certeza que deseja interromper a recorr\\xEAncia desta campanha? A campanha atual continuar\\xE1 sendo executada, mas n\\xE3o haver\\xE3o mais execu\\xE7\\xF5es futuras.\"}),campaignModalOpen&&/*#__PURE__*/_jsx(CampaignModal,{resetPagination:()=>{setPageNumber(1);fetchCampaigns();},open:campaignModalOpen,onClose:handleCloseCampaignModal,\"aria-labelledby\":\"form-dialog-title\",campaignId:selectedCampaign&&selectedCampaign.id}),user.profile===\"user\"&&(user===null||user===void 0?void 0:user.showCampaign)===\"disabled\"?/*#__PURE__*/_jsx(ForbiddenPage,{}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(MainHeader,{children:/*#__PURE__*/_jsxs(Grid,{style:{width:\"99.6%\"},container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:12,sm:8,item:true,children:/*#__PURE__*/_jsx(Title,{children:i18n.t(\"campaigns.title\")})}),/*#__PURE__*/_jsx(Grid,{xs:12,sm:4,item:true,children:/*#__PURE__*/_jsxs(Grid,{spacing:2,container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:6,sm:6,item:true,children:/*#__PURE__*/_jsx(TextField,{fullWidth:true,placeholder:i18n.t(\"campaigns.searchPlaceholder\"),type:\"search\",value:searchParam,onChange:handleSearch,InputProps:{startAdornment:/*#__PURE__*/_jsx(InputAdornment,{position:\"start\",children:/*#__PURE__*/_jsx(SearchIcon,{style:{color:\"gray\"}})})}})}),/*#__PURE__*/_jsx(Grid,{xs:6,sm:6,item:true,children:/*#__PURE__*/_jsx(Button,{fullWidth:true,variant:\"contained\",onClick:handleOpenCampaignModal,color:\"primary\",children:i18n.t(\"campaigns.buttons.add\")})})]})})]})}),/*#__PURE__*/_jsx(Paper,{className:classes.filterContainer,style:{padding:16,marginBottom:16},children:/*#__PURE__*/_jsxs(Grid,{spacing:2,container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:12,sm:4,item:true,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,variant:\"outlined\",size:\"small\",children:[/*#__PURE__*/_jsx(InputLabel,{children:\"Filtrar por Status\"}),/*#__PURE__*/_jsxs(Select,{value:statusFilter,onChange:handleStatusFilterChange,label:\"Filtrar por Status\",children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:\"Todos\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"INATIVA\",children:\"Inativa\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"PROGRAMADA\",children:\"Programada\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"EM_ANDAMENTO\",children:\"Em Andamento\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"CANCELADA\",children:\"Cancelada\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"FINALIZADA\",children:\"Finalizada\"})]})]})}),/*#__PURE__*/_jsx(Grid,{xs:12,sm:4,item:true,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,variant:\"outlined\",size:\"small\",children:[/*#__PURE__*/_jsx(InputLabel,{children:\"Filtrar por Recorr\\xEAncia\"}),/*#__PURE__*/_jsxs(Select,{value:recurrenceFilter,onChange:handleRecurrenceFilterChange,label:\"Filtrar por Recorr\\xEAncia\",children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:\"Todas\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"true\",children:\"Recorrentes\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"false\",children:\"\\xDAnicas\"})]})]})})]})}),/*#__PURE__*/_jsxs(Paper,{className:classes.mainPaper,variant:\"outlined\",children:[/*#__PURE__*/_jsxs(Table,{size:\"small\",children:[/*#__PURE__*/_jsx(TableHead,{children:/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{align:\"center\",className:classes.tableHeader,children:i18n.t(\"campaigns.table.name\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",className:classes.tableHeader,children:i18n.t(\"campaigns.table.status\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",className:classes.tableHeader,children:\"Recorr\\xEAncia\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",className:classes.tableHeader,children:i18n.t(\"campaigns.table.contactList\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",className:classes.tableHeader,children:i18n.t(\"campaigns.table.whatsapp\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",className:classes.tableHeader,children:i18n.t(\"campaigns.table.scheduledAt\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",className:classes.tableHeader,children:\"Pr\\xF3xima Execu\\xE7\\xE3o\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",className:classes.tableHeader,children:i18n.t(\"campaigns.table.completedAt\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",className:classes.tableHeader,children:i18n.t(\"campaigns.table.confirmation\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",className:classes.tableHeader,children:i18n.t(\"campaigns.table.actions\")})]})}),/*#__PURE__*/_jsx(TableBody,{children:/*#__PURE__*/_jsxs(_Fragment,{children:[campaigns.map(campaign=>{var _campaign$contactList,_campaign$whatsapp;return/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:8},children:[campaign.isRecurring&&/*#__PURE__*/_jsx(Tooltip,{title:\"Campanha Recorrente\",children:/*#__PURE__*/_jsx(RepeatIcon,{color:\"primary\",fontSize:\"small\"})}),campaign.name]})}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:/*#__PURE__*/_jsx(Chip,{label:formatStatus(campaign.status),color:getStatusColor(campaign.status),size:\"small\",className:classes.statusChip})}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:campaign.isRecurring?/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',flexDirection:'column',alignItems:'center',gap:4},children:[/*#__PURE__*/_jsx(Chip,{label:formatRecurrenceType(campaign.recurrenceType),className:classes.recurringChip,size:\"small\"}),/*#__PURE__*/_jsxs(\"span\",{style:{fontSize:'0.75rem',color:'#666'},children:[campaign.executionCount||0,\" execu\\xE7\\xF5es\"]})]}):/*#__PURE__*/_jsx(Chip,{label:\"\\xDAnica\",variant:\"outlined\",size:\"small\",className:classes.statusChip})}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:campaign.contactListId?((_campaign$contactList=campaign.contactList)===null||_campaign$contactList===void 0?void 0:_campaign$contactList.name)||\"Lista removida\":campaign.tagListId&&campaign.tagListId!==\"Nenhuma\"?\"Tag: \".concat(campaign.tagListId):\"Não definida\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:campaign.whatsappId?((_campaign$whatsapp=campaign.whatsapp)===null||_campaign$whatsapp===void 0?void 0:_campaign$whatsapp.name)||\"WhatsApp removido\":\"Não definido\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:campaign.scheduledAt?datetimeToClient(campaign.scheduledAt):\"Sem agendamento\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",className:classes.nextExecutionCell,children:campaign.isRecurring&&campaign.nextScheduledAt?/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:4},children:[/*#__PURE__*/_jsx(ScheduleIcon,{fontSize:\"small\",color:\"primary\"}),datetimeToClient(campaign.nextScheduledAt)]}):campaign.isRecurring&&campaign.status==='FINALIZADA'?/*#__PURE__*/_jsx(\"span\",{style:{color:'#666',fontSize:'0.875rem'},children:\"Recorr\\xEAncia finalizada\"}):\"—\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:campaign.completedAt?datetimeToClient(campaign.completedAt):\"Não concluída\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:campaign.confirmation?\"Habilitada\":\"Desabilitada\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',justifyContent:'center',gap:4},children:[campaign.status===\"EM_ANDAMENTO\"&&/*#__PURE__*/_jsx(Tooltip,{title:\"Parar Campanha\",children:/*#__PURE__*/_jsx(IconButton,{onClick:()=>cancelCampaign(campaign),size:\"small\",children:/*#__PURE__*/_jsx(PauseCircleOutlineIcon,{})})}),campaign.status===\"CANCELADA\"&&/*#__PURE__*/_jsx(Tooltip,{title:\"Reiniciar Campanha\",children:/*#__PURE__*/_jsx(IconButton,{onClick:()=>restartCampaign(campaign),size:\"small\",children:/*#__PURE__*/_jsx(PlayCircleOutlineIcon,{})})}),campaign.isRecurring&&campaign.status!==\"FINALIZADA\"&&/*#__PURE__*/_jsx(Tooltip,{title:\"Interromper Recorr\\xEAncia\",children:/*#__PURE__*/_jsx(IconButton,{onClick:()=>{setSelectedCampaign(campaign);setStopRecurrenceModalOpen(true);},size:\"small\",color:\"secondary\",children:/*#__PURE__*/_jsx(StopIcon,{})})}),/*#__PURE__*/_jsx(Tooltip,{title:\"Relat\\xF3rio\",children:/*#__PURE__*/_jsx(IconButton,{onClick:()=>history.push(\"/campaign/\".concat(campaign.id,\"/report\")),size:\"small\",children:/*#__PURE__*/_jsx(DescriptionIcon,{})})}),/*#__PURE__*/_jsx(Tooltip,{title:\"Editar\",children:/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:()=>handleEditCampaign(campaign),children:/*#__PURE__*/_jsx(EditIcon,{})})}),/*#__PURE__*/_jsx(Tooltip,{title:\"Excluir\",children:/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:e=>{setConfirmModalOpen(true);setDeletingCampaign(campaign);},children:/*#__PURE__*/_jsx(DeleteOutlineIcon,{})})})]})})]},campaign.id);}),loading&&/*#__PURE__*/_jsx(TableRowSkeleton,{columns:10})]})})]}),/*#__PURE__*/_jsxs(Box,{display:\"flex\",justifyContent:\"space-between\",alignItems:\"center\",p:2,children:[/*#__PURE__*/_jsx(Box,{display:\"flex\",alignItems:\"center\",gap:2,children:/*#__PURE__*/_jsxs(Box,{color:\"text.secondary\",fontSize:\"0.875rem\",children:[\"Total: \",totalCount,\" campanhas\"]})}),/*#__PURE__*/_jsx(TablePagination,{component:\"div\",count:totalCount,page:pageNumber-1// Material-UI usa índice baseado em 0\n,onPageChange:handlePageChange,rowsPerPage:pageSize,onRowsPerPageChange:handlePageSizeChange,rowsPerPageOptions:[5,10,25,50,100],labelRowsPerPage:\"Linhas por p\\xE1gina:\",labelDisplayedRows:_ref=>{let{from,to,count}=_ref;return\"\".concat(from,\"-\").concat(to,\" de \").concat(count!==-1?count:\"mais de \".concat(to));}})]})]})]})]});};export default Campaigns;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}