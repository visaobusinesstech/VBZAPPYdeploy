{"ast":null,"code":"import _objectSpread from\"/home/deploy/codigologlow/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useContext,useRef,useEffect}from\"react\";import{Dialog,DialogTitle,DialogActions,Button,TextField,Stack,Typography,Select,MenuItem,FormControl,InputLabel,Checkbox,IconButton,Box,Autocomplete,ListItemText,Divider,Alert,Chip}from\"@mui/material\";import{Add as AddIcon,Delete as DeleteIcon,Help as HelpIcon}from\"@mui/icons-material\";import{makeStyles}from\"@mui/styles\";import{green,red}from\"@mui/material/colors\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{i18n}from\"../../translate/i18n\";import api from\"../../services/api\";import{toast}from\"react-toastify\";import{Fragment as _Fragment,jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const useStyles=makeStyles(theme=>({root:{display:\"flex\",flexWrap:\"wrap\"},textField:{marginRight:8,flex:1},btnWrapper:{position:\"relative\"},buttonProgress:{color:green[500],position:\"absolute\",top:\"50%\",left:\"50%\",marginTop:-12,marginLeft:-12},online:{color:green[500]},offline:{color:red[500]},phraseContainer:{border:\"1px solid #e0e0e0\",borderRadius:\"8px\",padding:\"16px\",marginBottom:\"8px\",backgroundColor:\"#fafafa\"},addButton:{alignSelf:'flex-start',marginTop:\"8px\"},whatsappChip:{margin:\"2px\"}}));const CampaignModalPhrase=_ref=>{let{open,onClose,FlowCampaignId,onSave}=_ref;const classes=useStyles();const isMounted=useRef(true);const{user}=useContext(AuthContext);const companyId=user===null||user===void 0?void 0:user.companyId;// Estados básicos\nconst[campaignEditable,setCampaignEditable]=useState(true);const[loading,setLoading]=useState(false);const[active,setActive]=useState(true);// Estados do formulário\nconst[dataItem,setDataItem]=useState({name:\"\"});const[dataItemError,setDataItemError]=useState({name:false,flowId:false,phrases:false,whatsappIds:false// NOVA VALIDAÇÃO\n});// Estado para múltiplas frases\nconst[phrases,setPhrases]=useState([{text:\"\",type:\"exact\"}]);// Estados para flows e whatsapp\nconst[flowSelected,setFlowSelected]=useState(null);const[flowsData,setFlowsData]=useState([]);const[flowsDataComplete,setFlowsDataComplete]=useState([]);// ALTERAÇÃO: Estado para múltiplas conexões\nconst[selectedWhatsapps,setSelectedWhatsapps]=useState([]);const[whatsApps,setWhatsApps]=useState([]);// Buscar flows\nconst getFlows=async()=>{try{const flows=await api.get(\"/flowbuilder\");if(isMounted.current){setFlowsDataComplete(flows.data.flows||[]);setFlowsData((flows.data.flows||[]).map(flow=>flow.name));}return flows.data.flows||[];}catch(error){console.error(\"Erro ao buscar flows:\",error);if(isMounted.current){toast.error(\"Erro ao carregar fluxos\");}return[];}};// Buscar WhatsApps\nconst getWhatsApps=async()=>{try{const response=await api.get(\"/whatsapp\");if(isMounted.current){setWhatsApps(response.data||[]);}}catch(error){console.error(\"Erro ao buscar WhatsApps:\",error);if(isMounted.current){toast.error(\"Erro ao carregar conexões\");}}};// Carregar dados se for edição\nconst detailsPhrase=async flows=>{if(!FlowCampaignId||!isMounted.current)return;setLoading(true);try{console.log(\"Buscando dados da campanha ID: \".concat(FlowCampaignId));const response=await api.get(\"/flowcampaign/\".concat(FlowCampaignId));console.log(\"Resposta da API detailsPhrase:\",response.data);const details=response.data;if(!isMounted.current)return;// Preencher nome da campanha\nsetDataItem({name:details.name||\"\"});// Preencher status\nsetActive(details.status!==false);// ALTERAÇÃO: Preencher WhatsApps selecionados (múltiplos)\nif(details.whatsappIds&&Array.isArray(details.whatsappIds)){setSelectedWhatsapps(details.whatsappIds);}else if(details.whatsappId){// Compatibilidade com formato antigo\nsetSelectedWhatsapps([details.whatsappId]);}// Processar frases\nlet parsedPhrases=[];try{if(details.phrase){if(typeof details.phrase==='string'){try{const parsed=JSON.parse(details.phrase);if(Array.isArray(parsed)){parsedPhrases=parsed;}else{parsedPhrases=[{text:details.phrase,type:'exact'}];}}catch(_unused){parsedPhrases=[{text:details.phrase,type:'exact'}];}}else if(Array.isArray(details.phrase)){parsedPhrases=details.phrase;}else if(typeof details.phrase==='object'){parsedPhrases=[details.phrase];}}parsedPhrases=parsedPhrases.map(phrase=>({text:phrase.text||phrase,type:phrase.type||'exact'}));if(parsedPhrases.length===0){parsedPhrases=[{text:\"\",type:\"exact\"}];}console.log(\"Frases processadas:\",parsedPhrases);setPhrases(parsedPhrases);}catch(error){console.error(\"Erro ao processar frases:\",error);setPhrases([{text:\"\",type:\"exact\"}]);}// Selecionar flow\nif(details.flowId&&flows&&flows.length>0){const foundFlow=flows.find(flow=>flow.id===details.flowId);if(foundFlow){console.log(\"Flow encontrado:\",foundFlow.name);setFlowSelected(foundFlow.name);}else{console.warn(\"Flow não encontrado para ID:\",details.flowId);}}}catch(error){console.error(\"Erro ao carregar detalhes:\",error);if(isMounted.current){toast.error(\"Erro ao carregar dados da campanha\");}}finally{if(isMounted.current){setLoading(false);}}};// Resetar estados quando modal abre/fecha\nconst resetForm=()=>{setDataItem({name:\"\"});setPhrases([{text:\"\",type:\"exact\"}]);setFlowSelected(null);setSelectedWhatsapps([]);// ALTERAÇÃO: Resetar array\nsetActive(true);clearErrors();};// Inicialização\nuseEffect(()=>{isMounted.current=true;const initData=async()=>{if(open){console.log(\"Modal aberto. FlowCampaignId:\",FlowCampaignId);resetForm();const flows=await getFlows();await getWhatsApps();if(FlowCampaignId){await detailsPhrase(flows);}}};initData();return()=>{isMounted.current=false;};},[open,FlowCampaignId]);// Função para adicionar nova frase\nconst addPhraseField=()=>{setPhrases(prevPhrases=>[...prevPhrases,{text:\"\",type:\"exact\"}]);};// Função para remover frase\nconst removePhraseField=index=>{if(phrases.length>1){setPhrases(prevPhrases=>prevPhrases.filter((_,i)=>i!==index));}};// Função para atualizar frase específica\nconst updatePhrase=(index,field,value)=>{setPhrases(prevPhrases=>{const newPhrases=[...prevPhrases];if(newPhrases[index]){newPhrases[index]=_objectSpread(_objectSpread({},newPhrases[index]),{},{[field]:value});}return newPhrases;});};// Validação\nconst validateForm=()=>{const errors={name:!dataItem.name.trim(),flowId:!flowSelected,phrases:phrases.length===0||phrases.some(p=>!p.text.trim()),whatsappIds:selectedWhatsapps.length===0// NOVA VALIDAÇÃO\n};setDataItemError(errors);return!Object.values(errors).some(error=>error);};// Limpar erros\nconst clearErrors=()=>{setDataItemError({name:false,flowId:false,phrases:false,whatsappIds:false});};// Handler para mudanças no campo nome\nconst handleNameChange=event=>{const value=event.target.value;setDataItem(prev=>_objectSpread(_objectSpread({},prev),{},{name:value}));if(value.trim()&&dataItemError.name){setDataItemError(prev=>_objectSpread(_objectSpread({},prev),{},{name:false}));}};// NOVA FUNÇÃO: Handler para mudanças na seleção de WhatsApps\nconst handleWhatsappChange=event=>{const value=event.target.value;setSelectedWhatsapps(typeof value==='string'?value.split(','):value);if(value.length>0&&dataItemError.whatsappIds){setDataItemError(prev=>_objectSpread(_objectSpread({},prev),{},{whatsappIds:false}));}};// Salvar\nconst handleSave=async()=>{if(!validateForm()){toast.error(\"Por favor, preencha todos os campos obrigatórios\");return;}setLoading(true);try{var _flowsDataComplete$fi;const flowIdSelected=(_flowsDataComplete$fi=flowsDataComplete.find(flow=>flow.name===flowSelected))===null||_flowsDataComplete$fi===void 0?void 0:_flowsDataComplete$fi.id;if(!flowIdSelected){toast.error(\"Fluxo selecionado não encontrado\");return;}// Filtrar frases vazias\nconst validPhrases=phrases.filter(p=>p.text.trim());const payload=_objectSpread({name:dataItem.name.trim(),flowId:flowIdSelected,phrases:validPhrases,whatsappIds:selectedWhatsapps,// ALTERAÇÃO: Enviar array\nstatus:active},FlowCampaignId&&{id:FlowCampaignId});console.log(\"Payload para salvar:\",payload);if(FlowCampaignId){await api.put(\"/flowcampaign\",payload);toast.success(\"Campanha atualizada com sucesso!\");}else{await api.post(\"/flowcampaign\",payload);toast.success(\"Campanha criada com sucesso!\");}onSave&&onSave();handleClose();}catch(error){console.error(\"Erro ao salvar:\",error);toast.error(\"Erro ao salvar campanha\");}finally{if(isMounted.current){setLoading(false);}}};// Fechar modal\nconst handleClose=()=>{if(!isMounted.current)return;resetForm();onClose();};// Verificação de segurança antes de renderizar\nif(!user||!companyId){return null;}return/*#__PURE__*/_jsxs(Dialog,{open:open,onClose:handleClose,fullWidth:true,maxWidth:\"md\",scroll:\"paper\",disableEscapeKeyDown:loading,children:[/*#__PURE__*/_jsx(DialogTitle,{children:campaignEditable?/*#__PURE__*/_jsx(_Fragment,{children:FlowCampaignId?\"\".concat(i18n.t(\"campaignsPhrase.editCampaignWithFlowByPhrase\")):\"\".concat(i18n.t(\"campaignsPhrase.newCampaignWithFlowByPhrase\"))}):/*#__PURE__*/_jsx(_Fragment,{children:\"\".concat(i18n.t(\"campaigns.dialog.readonly\"))})}),!loading&&/*#__PURE__*/_jsxs(Stack,{sx:{padding:\"24px\",gap:\"20px\"},children:[/*#__PURE__*/_jsxs(Stack,{gap:1,children:[/*#__PURE__*/_jsx(Typography,{variant:\"subtitle1\",fontWeight:500,children:i18n.t(\"campaignsPhrase.phraseTriggerName\")}),/*#__PURE__*/_jsx(TextField,{label:\"Nome da campanha\",name:\"name\",variant:\"outlined\",error:dataItemError.name,value:dataItem.name,margin:\"dense\",onChange:handleNameChange,className:classes.textField,style:{width:\"100%\"},helperText:dataItemError.name?\"Nome é obrigatório\":\"\",disabled:loading})]}),/*#__PURE__*/_jsxs(Stack,{gap:1,children:[/*#__PURE__*/_jsx(Typography,{variant:\"subtitle1\",fontWeight:500,children:i18n.t(\"campaignsPhrase.chooseAStream\")}),/*#__PURE__*/_jsx(Autocomplete,{value:flowSelected,onChange:(event,newValue)=>{setFlowSelected(newValue);if(newValue&&dataItemError.flowId){setDataItemError(prev=>_objectSpread(_objectSpread({},prev),{},{flowId:false}));}},options:flowsData,disabled:loading,renderInput:params=>/*#__PURE__*/_jsx(TextField,_objectSpread(_objectSpread({},params),{},{label:\"Selecione um fluxo\",variant:\"outlined\",error:dataItemError.flowId,helperText:dataItemError.flowId?\"Fluxo é obrigatório\":\"\"})),style:{width:\"100%\"}})]}),/*#__PURE__*/_jsxs(Stack,{gap:1,children:[/*#__PURE__*/_jsxs(Typography,{variant:\"subtitle1\",fontWeight:500,children:[i18n.t(\"campaignsPhrase.selectAConnection\"),\" (M\\xFAltiplas)\"]}),/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,variant:\"outlined\",error:dataItemError.whatsappIds,children:[/*#__PURE__*/_jsx(InputLabel,{children:\"Conex\\xF5es WhatsApp\"}),/*#__PURE__*/_jsx(Select,{multiple:true,value:selectedWhatsapps,onChange:handleWhatsappChange,label:\"Conex\\xF5es WhatsApp\",disabled:loading,renderValue:selected=>/*#__PURE__*/_jsx(Box,{sx:{display:'flex',flexWrap:'wrap',gap:0.5},children:selected.map(whatsappId=>{const whatsapp=whatsApps.find(w=>w.id===whatsappId);return/*#__PURE__*/_jsx(Chip,{label:whatsapp?whatsapp.name:\"ID: \".concat(whatsappId),className:classes.whatsappChip,size:\"small\",color:(whatsapp===null||whatsapp===void 0?void 0:whatsapp.status)===\"CONNECTED\"?\"success\":\"default\"},whatsappId);})}),children:(whatsApps===null||whatsApps===void 0?void 0:whatsApps.length)>0&&whatsApps.map(whatsapp=>/*#__PURE__*/_jsxs(MenuItem,{value:whatsapp.id,children:[/*#__PURE__*/_jsx(Checkbox,{checked:selectedWhatsapps.indexOf(whatsapp.id)>-1}),/*#__PURE__*/_jsx(ListItemText,{primary:/*#__PURE__*/_jsxs(Typography,{component:\"span\",style:{fontSize:14},children:[whatsapp.name,\" \\xA0\",/*#__PURE__*/_jsxs(\"span\",{className:whatsapp.status===\"CONNECTED\"?classes.online:classes.offline,children:[\"(\",whatsapp.status,\")\"]})]})})]},whatsapp.id))}),dataItemError.whatsappIds&&/*#__PURE__*/_jsx(Typography,{variant:\"caption\",color:\"error\",sx:{mt:1,ml:2},children:\"Pelo menos uma conex\\xE3o deve ser selecionada\"})]}),selectedWhatsapps.length>0&&/*#__PURE__*/_jsx(Alert,{severity:\"info\",sx:{mt:1},children:/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",children:[/*#__PURE__*/_jsxs(\"strong\",{children:[selectedWhatsapps.length,\" conex\\xE3o(\\xF5es) selecionada(s):\"]}),/*#__PURE__*/_jsx(\"br\",{}),\"A campanha ser\\xE1 executada quando qualquer uma dessas conex\\xF5es receber mensagens que fa\\xE7am match com as frases configuradas.\"]})})]}),/*#__PURE__*/_jsx(Divider,{}),/*#__PURE__*/_jsxs(Stack,{gap:2,children:[/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",gap:1,children:[/*#__PURE__*/_jsx(Typography,{variant:\"subtitle1\",fontWeight:500,children:\"Frases/Palavras que disparam o fluxo\"}),/*#__PURE__*/_jsx(IconButton,{size:\"small\",children:/*#__PURE__*/_jsx(HelpIcon,{fontSize:\"small\"})})]}),/*#__PURE__*/_jsx(Alert,{severity:\"info\",sx:{mb:2},children:/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Correspond\\xEAncia Exata:\"}),\" A mensagem deve ser id\\xEAntica \\xE0 frase configurada.\",/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(\"strong\",{children:\"Correspond\\xEAncia Parcial:\"}),\" A frase pode estar contida em qualquer parte da mensagem.\"]})}),phrases.map((phrase,index)=>/*#__PURE__*/_jsx(Box,{className:classes.phraseContainer,children:/*#__PURE__*/_jsxs(Stack,{direction:\"row\",gap:2,alignItems:\"flex-start\",children:[/*#__PURE__*/_jsx(TextField,{label:\"Frase \".concat(index+1),value:phrase.text,onChange:e=>{updatePhrase(index,'text',e.target.value);if(e.target.value.trim()&&dataItemError.phrases){setDataItemError(prev=>_objectSpread(_objectSpread({},prev),{},{phrases:false}));}},variant:\"outlined\",fullWidth:true,placeholder:\"Digite a frase ou palavra-chave\",error:dataItemError.phrases&&!phrase.text.trim(),helperText:dataItemError.phrases&&!phrase.text.trim()?\"Frase é obrigatória\":\"\",disabled:loading}),/*#__PURE__*/_jsxs(FormControl,{sx:{minWidth:140},children:[/*#__PURE__*/_jsx(InputLabel,{children:\"Tipo\"}),/*#__PURE__*/_jsxs(Select,{value:phrase.type,onChange:e=>updatePhrase(index,'type',e.target.value),label:\"Tipo\",disabled:loading,children:[/*#__PURE__*/_jsx(MenuItem,{value:\"exact\",children:\"Exata\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"partial\",children:\"Parcial\"})]})]}),phrases.length>1&&/*#__PURE__*/_jsx(IconButton,{onClick:()=>removePhraseField(index),color:\"error\",sx:{mt:1},disabled:loading,children:/*#__PURE__*/_jsx(DeleteIcon,{})})]})},index)),/*#__PURE__*/_jsx(Button,{variant:\"outlined\",startIcon:/*#__PURE__*/_jsx(AddIcon,{}),onClick:addPhraseField,className:classes.addButton,disabled:loading,children:\"Adicionar Frase\"})]}),/*#__PURE__*/_jsx(Divider,{}),/*#__PURE__*/_jsxs(Stack,{direction:\"row\",gap:2,alignItems:\"center\",children:[/*#__PURE__*/_jsx(Typography,{variant:\"subtitle1\",fontWeight:500,children:i18n.t(\"campaignsPhrase.status\")}),/*#__PURE__*/_jsx(Checkbox,{checked:active,onChange:()=>setActive(prev=>!prev),disabled:loading}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",color:\"textSecondary\",children:active?\"Ativa\":\"Inativa\"})]})]}),/*#__PURE__*/_jsxs(DialogActions,{sx:{padding:\"16px 24px\"},children:[/*#__PURE__*/_jsx(Button,{variant:\"outlined\",onClick:handleClose,disabled:loading,children:i18n.t(\"campaignsPhrase.cancel\")}),/*#__PURE__*/_jsx(Button,{variant:\"contained\",onClick:handleSave,disabled:loading,children:loading?\"Salvando...\":FlowCampaignId?\"Atualizar\":\"Criar\"})]})]});};export default CampaignModalPhrase;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}