{"ast":null,"code":"import _objectSpread from\"/home/deploy/atendechatop/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from\"react\";import{toast}from\"react-toastify\";import{Paper,Table,TableBody,TableCell,TableHead,TableRow,Typography,Grid,Card,CardContent,TextField,Button,FormControl,InputLabel,Select,MenuItem,Box,Chip}from\"@material-ui/core\";import{makeStyles}from\"@material-ui/core/styles\";import{format}from\"date-fns\";import{ptBR}from\"date-fns/locale\";import api from\"../../services/api\";import toastError from\"../../errors/toastError\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const useStyles=makeStyles(theme=>({root:{padding:theme.spacing(3)},title:{marginBottom:theme.spacing(3)},card:{marginBottom:theme.spacing(2)},statsCard:{textAlign:\"center\",marginBottom:theme.spacing(2)},statsValue:{fontSize:\"2rem\",fontWeight:\"bold\",color:theme.palette.primary.main},statsLabel:{color:theme.palette.text.secondary},filterSection:{marginBottom:theme.spacing(3),padding:theme.spacing(2),backgroundColor:theme.palette.background.default},table:{minWidth:650},chip:{margin:theme.spacing(0.5)}}));const RelatorioVendas=()=>{const classes=useStyles();const[loading,setLoading]=useState(false);const[relatorio,setRelatorio]=useState(null);const[users,setUsers]=useState([]);const[filters,setFilters]=useState({dateFrom:format(new Date().setDate(1),\"yyyy-MM-dd\"),dateTo:format(new Date(),\"yyyy-MM-dd\"),userId:\"\",motivoNaoVenda:\"\",motivoFinalizacao:\"\"});useEffect(()=>{fetchUsers();},[]);const fetchUsers=async()=>{try{const{data}=await api.get(\"/users\");setUsers(data.users);}catch(err){toastError(err);}};const handleFilterChange=(field,value)=>{setFilters(prev=>_objectSpread(_objectSpread({},prev),{},{[field]:value}));};const handleGenerateReport=async()=>{if(!filters.dateFrom||!filters.dateTo){toast.error(\"Por favor, selecione o período\");return;}setLoading(true);try{const params=new URLSearchParams({dateFrom:filters.dateFrom,dateTo:filters.dateTo});if(filters.userId){params.append(\"userId\",filters.userId);}const{data}=await api.get(\"/ticketreport/vendas?\".concat(params));setRelatorio(data);}catch(err){toastError(err);}finally{setLoading(false);}};const formatCurrency=value=>{return new Intl.NumberFormat(\"pt-BR\",{style:\"currency\",currency:\"BRL\"}).format(value);};// Novo: filtrar tickets por motivo\nconst filteredTickets=((relatorio===null||relatorio===void 0?void 0:relatorio.tickets)||[]).filter(ticket=>{let motivoNaoVendaOk=true;let motivoFinalizacaoOk=true;if(filters.motivoNaoVenda){motivoNaoVendaOk=ticket.motivoNaoVenda===filters.motivoNaoVenda;}if(filters.motivoFinalizacao){motivoFinalizacaoOk=ticket.motivoFinalizacao===filters.motivoFinalizacao;}return motivoNaoVendaOk&&motivoFinalizacaoOk;});if(!relatorio){return/*#__PURE__*/_jsxs(\"div\",{className:classes.root,children:[/*#__PURE__*/_jsx(Typography,{variant:\"h4\",className:classes.title,children:\"Relat\\xF3rio de Vendas\"}),/*#__PURE__*/_jsx(Paper,{className:classes.filterSection,children:/*#__PURE__*/_jsxs(Grid,{container:true,spacing:2,alignItems:\"center\",children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsx(TextField,{label:\"Data Inicial\",type:\"date\",value:filters.dateFrom,onChange:e=>handleFilterChange(\"dateFrom\",e.target.value),fullWidth:true,InputLabelProps:{shrink:true}})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsx(TextField,{label:\"Data Final\",type:\"date\",value:filters.dateTo,onChange:e=>handleFilterChange(\"dateTo\",e.target.value),fullWidth:true,InputLabelProps:{shrink:true}})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,children:[/*#__PURE__*/_jsx(InputLabel,{children:\"Atendente\"}),/*#__PURE__*/_jsxs(Select,{value:filters.userId,onChange:e=>handleFilterChange(\"userId\",e.target.value),children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:\"Todos\"}),users.map(user=>/*#__PURE__*/_jsx(MenuItem,{value:user.id,children:user.name},user.id))]})]})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",onClick:handleGenerateReport,disabled:loading,fullWidth:true,children:loading?\"Gerando...\":\"Gerar Relatório\"})})]})})]});}return/*#__PURE__*/_jsxs(\"div\",{className:classes.root,children:[/*#__PURE__*/_jsx(Typography,{variant:\"h4\",className:classes.title,children:\"Relat\\xF3rio de Vendas\"}),/*#__PURE__*/_jsx(Paper,{className:classes.filterSection,children:/*#__PURE__*/_jsxs(Grid,{container:true,spacing:2,alignItems:\"center\",children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsx(TextField,{label:\"Data Inicial\",type:\"date\",value:filters.dateFrom,onChange:e=>handleFilterChange(\"dateFrom\",e.target.value),fullWidth:true,InputLabelProps:{shrink:true}})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsx(TextField,{label:\"Data Final\",type:\"date\",value:filters.dateTo,onChange:e=>handleFilterChange(\"dateTo\",e.target.value),fullWidth:true,InputLabelProps:{shrink:true}})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,children:[/*#__PURE__*/_jsx(InputLabel,{children:\"Atendente\"}),/*#__PURE__*/_jsxs(Select,{value:filters.userId,onChange:e=>handleFilterChange(\"userId\",e.target.value),children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:\"Todos\"}),users.map(user=>/*#__PURE__*/_jsx(MenuItem,{value:user.id,children:user.name},user.id))]})]})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,children:[/*#__PURE__*/_jsx(InputLabel,{children:\"Motivo da N\\xE3o Venda\"}),/*#__PURE__*/_jsxs(Select,{value:filters.motivoNaoVenda,onChange:e=>handleFilterChange(\"motivoNaoVenda\",e.target.value),children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:\"Todos\"}),((relatorio===null||relatorio===void 0?void 0:relatorio.motivosNaoVenda)||[]).map((item,idx)=>/*#__PURE__*/_jsx(MenuItem,{value:item.motivo,children:item.motivo},idx))]})]})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,children:[/*#__PURE__*/_jsx(InputLabel,{children:\"Motivo da Finaliza\\xE7\\xE3o\"}),/*#__PURE__*/_jsxs(Select,{value:filters.motivoFinalizacao,onChange:e=>handleFilterChange(\"motivoFinalizacao\",e.target.value),children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:\"Todos\"}),((relatorio===null||relatorio===void 0?void 0:relatorio.motivosFinalizacao)||[]).map((item,idx)=>/*#__PURE__*/_jsx(MenuItem,{value:item.motivo,children:item.motivo},idx))]})]})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",onClick:handleGenerateReport,disabled:loading,fullWidth:true,children:loading?\"Gerando...\":\"Gerar Relatório\"})})]})}),/*#__PURE__*/_jsxs(Grid,{container:true,spacing:3,className:classes.card,children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsx(Card,{className:classes.statsCard,children:/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsx(Typography,{className:classes.statsValue,children:relatorio.totalVendas}),/*#__PURE__*/_jsx(Typography,{className:classes.statsLabel,children:\"Total de Vendas\"})]})})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsx(Card,{className:classes.statsCard,children:/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsx(Typography,{className:classes.statsValue,children:formatCurrency(relatorio.totalValorVendas)}),/*#__PURE__*/_jsx(Typography,{className:classes.statsLabel,children:\"Valor Total de Vendas\"})]})})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsx(Card,{className:classes.statsCard,children:/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsx(Typography,{className:classes.statsValue,children:relatorio.totalNaoVendas}),/*#__PURE__*/_jsx(Typography,{className:classes.statsLabel,children:\"N\\xE3o Vendas\"})]})})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsx(Card,{className:classes.statsCard,children:/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsx(Typography,{className:classes.statsValue,children:relatorio.mediaTicketPorAtendente.toFixed(1)}),/*#__PURE__*/_jsx(Typography,{className:classes.statsLabel,children:\"M\\xE9dia de Tickets por Atendente\"})]})})})]}),relatorio.motivosNaoVenda.length>0&&/*#__PURE__*/_jsxs(Paper,{className:classes.card,children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",style:{padding:16},children:\"Motivos de N\\xE3o Venda\"}),/*#__PURE__*/_jsx(Box,{style:{padding:16},children:relatorio.motivosNaoVenda.map((item,index)=>/*#__PURE__*/_jsx(Chip,{label:\"\".concat(item.motivo,\" (\").concat(item.quantidade,\")\"),className:classes.chip,color:\"secondary\",variant:\"outlined\"},index))})]}),filteredTickets.length>0&&/*#__PURE__*/_jsxs(Paper,{className:classes.card,children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",style:{padding:16},children:\"Tickets Finalizados\"}),/*#__PURE__*/_jsxs(Table,{className:classes.table,children:[/*#__PURE__*/_jsx(TableHead,{children:/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{children:\"ID\"}),/*#__PURE__*/_jsx(TableCell,{children:\"Atendente\"}),/*#__PURE__*/_jsx(TableCell,{children:\"Data\"}),/*#__PURE__*/_jsx(TableCell,{children:\"Valor da Venda\"}),/*#__PURE__*/_jsx(TableCell,{children:\"Motivo da N\\xE3o Venda\"}),/*#__PURE__*/_jsx(TableCell,{children:\"Motivo da Finaliza\\xE7\\xE3o\"})]})}),/*#__PURE__*/_jsx(TableBody,{children:filteredTickets.map(ticket=>{var _ticket$user;return/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{children:ticket.id}),/*#__PURE__*/_jsx(TableCell,{children:((_ticket$user=ticket.user)===null||_ticket$user===void 0?void 0:_ticket$user.name)||\"-\"}),/*#__PURE__*/_jsx(TableCell,{children:format(new Date(ticket.createdAt),\"dd/MM/yyyy\")}),/*#__PURE__*/_jsx(TableCell,{children:ticket.valorVenda?formatCurrency(ticket.valorVenda):\"-\"}),/*#__PURE__*/_jsx(TableCell,{children:ticket.motivoNaoVenda||\"-\"}),/*#__PURE__*/_jsx(TableCell,{children:ticket.motivoFinalizacao||\"-\"})]},ticket.id);})})]})]}),/*#__PURE__*/_jsxs(Paper,{className:classes.card,children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",style:{padding:16},children:\"Desempenho por Atendente\"}),/*#__PURE__*/_jsxs(Table,{className:classes.table,children:[/*#__PURE__*/_jsx(TableHead,{children:/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{children:\"Atendente\"}),/*#__PURE__*/_jsx(TableCell,{align:\"right\",children:\"Total de Vendas\"}),/*#__PURE__*/_jsx(TableCell,{align:\"right\",children:\"Valor Total de Vendas\"}),/*#__PURE__*/_jsx(TableCell,{align:\"right\",children:\"N\\xE3o Vendas\"}),/*#__PURE__*/_jsx(TableCell,{align:\"right\",children:\"Total de Tickets\"}),/*#__PURE__*/_jsx(TableCell,{align:\"right\",children:\"M\\xE9dia de Tickets\"})]})}),/*#__PURE__*/_jsx(TableBody,{children:relatorio.atendentes.map(atendente=>/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{children:atendente.name}),/*#__PURE__*/_jsx(TableCell,{align:\"right\",children:atendente.totalVendas}),/*#__PURE__*/_jsx(TableCell,{align:\"right\",children:formatCurrency(atendente.totalValorVendas)}),/*#__PURE__*/_jsx(TableCell,{align:\"right\",children:atendente.totalNaoVendas}),/*#__PURE__*/_jsx(TableCell,{align:\"right\",children:atendente.totalTickets}),/*#__PURE__*/_jsx(TableCell,{align:\"right\",children:atendente.mediaTicket})]},atendente.id))})]})]})]});};export default RelatorioVendas;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}