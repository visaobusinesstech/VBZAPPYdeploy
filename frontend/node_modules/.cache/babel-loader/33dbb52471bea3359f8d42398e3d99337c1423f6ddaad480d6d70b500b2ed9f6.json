{"ast":null,"code":"import _objectSpread from\"/home/deploy/codigologlow/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useReducer,useContext,useCallback}from\"react\";import{toast}from\"react-toastify\";import{makeStyles}from\"@material-ui/core/styles\";import Paper from\"@material-ui/core/Paper\";import Button from\"@material-ui/core/Button\";import Table from\"@material-ui/core/Table\";import TableBody from\"@material-ui/core/TableBody\";import TableCell from\"@material-ui/core/TableCell\";import TableHead from\"@material-ui/core/TableHead\";import TableRow from\"@material-ui/core/TableRow\";import IconButton from\"@material-ui/core/IconButton\";import SearchIcon from\"@material-ui/icons/Search\";import TextField from\"@material-ui/core/TextField\";import InputAdornment from\"@material-ui/core/InputAdornment\";import PhoneIcon from'@material-ui/icons/Phone';import DownloadIcon from'@material-ui/icons/CloudDownload';import VisibilityIcon from'@material-ui/icons/Visibility';import CallMadeIcon from'@material-ui/icons/CallMade';import CallReceivedIcon from'@material-ui/icons/CallReceived';import CallEndIcon from'@material-ui/icons/CallEnd';import DoneIcon from'@material-ui/icons/Done';import PhoneMissedIcon from'@material-ui/icons/PhoneMissed';import Chip from'@material-ui/core/Chip';import Card from'@material-ui/core/Card';import CardContent from'@material-ui/core/CardContent';import Typography from'@material-ui/core/Typography';import MainContainer from\"../../components/MainContainer\";import MainHeader from\"../../components/MainHeader\";import Title from\"../../components/Title\";import api from\"../../services/api\";import{i18n}from\"../../translate/i18n\";import TableRowSkeleton from\"../../components/TableRowSkeleton\";import toastError from\"../../errors/toastError\";import{Grid}from\"@material-ui/core\";import{isArray}from\"lodash\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const reducer=(state,action)=>{if(action.type===\"LOAD_CALL_HISTORY\"){const callHistory=action.payload;const newCallHistory=[];if(isArray(callHistory)){callHistory.forEach(call=>{const callIndex=state.findIndex(c=>c.id===call.id);if(callIndex!==-1){state[callIndex]=call;}else{newCallHistory.push(call);}});}return[...state,...newCallHistory];}if(action.type===\"UPDATE_CALL_HISTORY\"){const call=action.payload;const callIndex=state.findIndex(c=>c.id===call.id);if(callIndex!==-1){state[callIndex]=call;return[...state];}else{return[call,...state];}}if(action.type===\"RESET\"){return[];}};const useStyles=makeStyles(theme=>({mainPaper:_objectSpread({flex:1,padding:theme.spacing(1),overflowY:\"scroll\"},theme.scrollbarStyles),phoneChip:{backgroundColor:'#e3f2fd',color:'#1976d2'},callButton:{backgroundColor:'#4caf50',color:'white','&:hover':{backgroundColor:'#45a049'}},statusChip:{minWidth:'80px'},directionIcon:{marginRight:theme.spacing(0.5)},statsCard:{minHeight:'80px',display:'flex',alignItems:'center',justifyContent:'center',background:'linear-gradient(45deg, #2196F3 30%, #21CBF3 90%)',color:'white','&.total':{background:'linear-gradient(45deg, #2196F3 30%, #21CBF3 90%)'},'&.rejected':{background:'linear-gradient(45deg, #f44336 30%, #ff7961 90%)'},'&.served':{background:'linear-gradient(45deg, #4caf50 30%, #81c784 90%)'},'&.finished':{background:'linear-gradient(45deg, #ff9800 30%, #ffb74d 90%)'}},statsContent:{textAlign:'center',padding:'8px !important'},statsNumber:{fontSize:'2rem',fontWeight:'bold'},statsLabel:{fontSize:'0.875rem',opacity:0.9}}));const CallHistoricals=()=>{const classes=useStyles();const[loading,setLoading]=useState(false);const[pageNumber,setPageNumber]=useState(1);const[hasMore,setHasMore]=useState(false);const[searchParam,setSearchParam]=useState(\"\");const[callHistory,dispatch]=useReducer(reducer,[]);const[statistics,setStatistics]=useState({total:0,totalReject:0,totalServed:0,totalFinish:0});const{user,socket}=useContext(AuthContext);const{profile}=user;useEffect(()=>{dispatch({type:\"RESET\"});setPageNumber(1);},[searchParam]);useEffect(()=>{setLoading(true);const delayDebounceFn=setTimeout(()=>{fetchCallHistory();},500);return()=>clearTimeout(delayDebounceFn);// eslint-disable-next-line react-hooks/exhaustive-deps\n},[searchParam,pageNumber]);useEffect(()=>{const companyId=user.companyId;const onCallHistoryEvent=data=>{if(data.action===\"update\"||data.action===\"create\"){dispatch({type:\"UPDATE_CALL_HISTORY\",payload:data.record});}};if(socket){socket.on(\"company-\".concat(companyId,\"-call-history\"),onCallHistoryEvent);}return()=>{if(socket){socket.off(\"company-\".concat(companyId,\"-call-history\"),onCallHistoryEvent);}};},[socket,user.companyId]);const fetchCallHistory=async()=>{try{const{data}=await api.get(\"/call/historical\",{params:{searchParam,pageNumber}});dispatch({type:\"LOAD_CALL_HISTORY\",payload:data.historical.resultFinal});setStatistics({total:data.historical.total||0,totalReject:data.historical.totalReject||0,totalServed:data.historical.totalServed||0,totalFinish:data.historical.totalFinish||0});setHasMore(data.hasMore);setLoading(false);}catch(err){toastError(err);setLoading(false);}};const handleSearch=event=>{setSearchParam(event.target.value.toLowerCase());};const handleMakeCall=callUrl=>{window.open(callUrl,'_blank');};const formatDate=dateString=>{const date=new Date(dateString);return date.toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});};const formatPhone=phone=>{// Formato brasileiro: +55 (11) 99999-9999\nif(phone&&phone.length>=10){const cleaned=phone.replace(/\\D/g,'');if(cleaned.startsWith('55')){const ddd=cleaned.substring(2,4);const number=cleaned.substring(4);if(number.length===9){return\"+55 (\".concat(ddd,\") \").concat(number.substring(0,5),\"-\").concat(number.substring(5));}else if(number.length===8){return\"+55 (\".concat(ddd,\") \").concat(number.substring(0,4),\"-\").concat(number.substring(4));}}}return phone;};const getStatusColor=status=>{switch(status){case'ENDED':return'default';case'ACTIVE':return'primary';case'RINGING':return'secondary';case'BUSY':return'error';case'NO_ANSWER':return'warning';case'REJECTED':return'error';default:return'default';}};const getStatusLabel=status=>{switch(status){case'ENDED':return'Finalizada';case'ACTIVE':return'Ativa';case'RINGING':return'Tocando';case'BUSY':return'Ocupado';case'NO_ANSWER':return'Não Atendida';case'REJECTED':return'Rejeitada';default:return status||'N/A';}};const getDirectionIcon=direction=>{if(direction==='OUTCOMING'){return/*#__PURE__*/_jsx(CallMadeIcon,{className:classes.directionIcon});}else if(direction==='INCOMING'){return/*#__PURE__*/_jsx(CallReceivedIcon,{className:classes.directionIcon});}return null;};const getDirectionLabel=direction=>{switch(direction){case'OUTCOMING':return'Saída';case'INCOMING':return'Entrada';default:return direction||'N/A';}};const formatDuration=duration=>{if(!duration)return'N/A';const minutes=Math.floor(duration/60);const seconds=duration%60;return\"\".concat(minutes,\":\").concat(seconds.toString().padStart(2,'0'));};const loadMore=()=>{setPageNumber(prevState=>prevState+1);};const handleScroll=e=>{if(!hasMore||loading)return;const{scrollTop,scrollHeight,clientHeight}=e.currentTarget;if(scrollHeight-(scrollTop+100)<clientHeight){loadMore();}};return/*#__PURE__*/_jsxs(MainContainer,{children:[/*#__PURE__*/_jsx(MainHeader,{children:/*#__PURE__*/_jsxs(Grid,{style:{width:\"99.6%\"},container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:12,item:true,children:/*#__PURE__*/_jsx(Title,{children:\"Hist\\xF3rico de Liga\\xE7\\xF5es\"})}),/*#__PURE__*/_jsx(Grid,{xs:12,item:true,style:{marginBottom:'16px'},children:/*#__PURE__*/_jsxs(Grid,{container:true,spacing:2,children:[/*#__PURE__*/_jsx(Grid,{xs:12,sm:6,md:3,item:true,children:/*#__PURE__*/_jsx(Card,{className:\"\".concat(classes.statsCard,\" total\"),children:/*#__PURE__*/_jsxs(CardContent,{className:classes.statsContent,children:[/*#__PURE__*/_jsx(Typography,{className:classes.statsNumber,children:statistics.total}),/*#__PURE__*/_jsx(Typography,{className:classes.statsLabel,children:\"Total de Liga\\xE7\\xF5es\"})]})})}),/*#__PURE__*/_jsx(Grid,{xs:12,sm:6,md:3,item:true,children:/*#__PURE__*/_jsx(Card,{className:\"\".concat(classes.statsCard,\" rejected\"),children:/*#__PURE__*/_jsxs(CardContent,{className:classes.statsContent,children:[/*#__PURE__*/_jsx(Typography,{className:classes.statsNumber,children:statistics.totalReject}),/*#__PURE__*/_jsx(Typography,{className:classes.statsLabel,children:\"Liga\\xE7\\xF5es Rejeitadas\"})]})})}),/*#__PURE__*/_jsx(Grid,{xs:12,sm:6,md:3,item:true,children:/*#__PURE__*/_jsx(Card,{className:\"\".concat(classes.statsCard,\" served\"),children:/*#__PURE__*/_jsxs(CardContent,{className:classes.statsContent,children:[/*#__PURE__*/_jsx(Typography,{className:classes.statsNumber,children:statistics.totalServed}),/*#__PURE__*/_jsx(Typography,{className:classes.statsLabel,children:\"Liga\\xE7\\xF5es Atendidas\"})]})})}),/*#__PURE__*/_jsx(Grid,{xs:12,sm:6,md:3,item:true,children:/*#__PURE__*/_jsx(Card,{className:\"\".concat(classes.statsCard,\" finished\"),children:/*#__PURE__*/_jsxs(CardContent,{className:classes.statsContent,children:[/*#__PURE__*/_jsx(Typography,{className:classes.statsNumber,children:statistics.totalFinish}),/*#__PURE__*/_jsx(Typography,{className:classes.statsLabel,children:\"Liga\\xE7\\xF5es Finalizadas\"})]})})})]})}),/*#__PURE__*/_jsx(Grid,{xs:12,sm:8,item:true}),/*#__PURE__*/_jsx(Grid,{xs:12,sm:4,item:true,children:/*#__PURE__*/_jsx(Grid,{spacing:2,container:true,children:/*#__PURE__*/_jsx(Grid,{xs:12,sm:12,item:true,children:/*#__PURE__*/_jsx(TextField,{fullWidth:true,placeholder:\"Pesquisar por nome ou telefone...\",type:\"search\",value:searchParam,onChange:handleSearch,InputProps:{startAdornment:/*#__PURE__*/_jsx(InputAdornment,{position:\"start\",children:/*#__PURE__*/_jsx(SearchIcon,{style:{color:\"gray\"}})})}})})})})]})}),/*#__PURE__*/_jsx(Paper,{className:classes.mainPaper,variant:\"outlined\",onScroll:handleScroll,children:/*#__PURE__*/_jsxs(Table,{size:\"small\",children:[/*#__PURE__*/_jsx(TableHead,{children:/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Nome\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Telefone\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Atendente\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Data/Hora\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Dire\\xE7\\xE3o\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Status\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Dura\\xE7\\xE3o\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Tipo\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Grava\\xE7\\xE3o\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"A\\xE7\\xF5es\"})]})}),/*#__PURE__*/_jsx(TableBody,{children:/*#__PURE__*/_jsxs(_Fragment,{children:[callHistory.map(call=>{var _call$devices,_call$devices2,_call$user,_call$devices3,_call$devices4,_call$devices5,_call$devices6,_call$devices7,_call$devices8,_call$devices9;return/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:call.name||(((_call$devices2=call.devices)===null||_call$devices2===void 0?void 0:_call$devices2.direction)==='INCOMING'?'Ligação Recebida':'N/A')}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:/*#__PURE__*/_jsx(Chip,{label:formatPhone(call.phone_to),className:classes.phoneChip,size:\"small\"})}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:((_call$user=call.user)===null||_call$user===void 0?void 0:_call$user.name)||'N/A'}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:formatDate(call.createdAt||((_call$devices3=call.devices)===null||_call$devices3===void 0?void 0:_call$devices3.created_date))}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',justifyContent:'center'},children:[getDirectionIcon((_call$devices4=call.devices)===null||_call$devices4===void 0?void 0:_call$devices4.direction),getDirectionLabel((_call$devices5=call.devices)===null||_call$devices5===void 0?void 0:_call$devices5.direction)]})}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:/*#__PURE__*/_jsx(Chip,{label:getStatusLabel((_call$devices6=call.devices)===null||_call$devices6===void 0?void 0:_call$devices6.status),color:getStatusColor((_call$devices7=call.devices)===null||_call$devices7===void 0?void 0:_call$devices7.status),size:\"small\",className:classes.statusChip})}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:formatDuration((_call$devices8=call.devices)===null||_call$devices8===void 0?void 0:_call$devices8.duration)}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:/*#__PURE__*/_jsx(Chip,{label:((_call$devices9=call.devices)===null||_call$devices9===void 0?void 0:_call$devices9.type)||'N/A',variant:\"outlined\",size:\"small\"})}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:call.callSaveUrl&&/*#__PURE__*/_jsx(IconButton,{size:\"small\",className:classes.callButton,onClick:()=>{const link=document.createElement('a');link.href=call.callSaveUrl;link.setAttribute('download','audio.mp3');document.body.appendChild(link);link.click();document.body.removeChild(link);},title:\"Baixar \\xE1udio\",children:/*#__PURE__*/_jsx(DownloadIcon,{})})}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:call.url&&/*#__PURE__*/_jsx(IconButton,{size:\"small\",className:classes.callButton,onClick:()=>handleMakeCall(call.url),title:\"Fazer liga\\xE7\\xE3o\",children:/*#__PURE__*/_jsx(PhoneIcon,{})})})]},call.id||((_call$devices=call.devices)===null||_call$devices===void 0?void 0:_call$devices.id));}),loading&&/*#__PURE__*/_jsx(TableRowSkeleton,{columns:9}),!loading&&callHistory.length===0&&/*#__PURE__*/_jsx(TableRow,{children:/*#__PURE__*/_jsx(TableCell,{colSpan:9,align:\"center\",children:\"Nenhum registro encontrado\"})})]})})]})})]});};export default CallHistoricals;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}