{"ast":null,"code":"import _objectSpread from\"/home/deploy/atendechatop/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useCallback,useContext,useEffect}from\"react\";import{toast}from\"react-toastify\";import{format,parseISO,set}from\"date-fns\";import Menu from\"@material-ui/core/Menu\";import MenuItem from\"@material-ui/core/MenuItem\";import PopupState,{bindTrigger,bindMenu}from\"material-ui-popup-state\";import{Stack}from\"@mui/material\";import{makeStyles}from\"@material-ui/core/styles\";import{useHistory}from\"react-router-dom\";import{green}from\"@material-ui/core/colors\";import{Button,TableBody,TableRow,TableCell,IconButton,Table,TableHead,Paper,Tooltip,Typography,CircularProgress,Divider}from\"@material-ui/core\";import{Edit,CheckCircle,SignalCellularConnectedNoInternet2Bar,SignalCellularConnectedNoInternet0Bar,SignalCellular4Bar,CropFree,DeleteOutline,Facebook,Instagram,WhatsApp}from\"@material-ui/icons\";import FacebookLogin from\"react-facebook-login/dist/facebook-login-render-props\";import MainContainer from\"../../components/MainContainer\";import MainHeader from\"../../components/MainHeader\";import MainHeaderButtonsWrapper from\"../../components/MainHeaderButtonsWrapper\";import Title from\"../../components/Title\";import TableRowSkeleton from\"../../components/TableRowSkeleton\";import{AuthContext}from\"../../context/Auth/AuthContext\";import useCompanies from\"../../hooks/useCompanies\";import api from\"../../services/api\";import WhatsAppModal from\"../../components/WhatsAppModal\";import WhatsAppModalCompany from\"../../components/CompanyWhatsapps\";import ConfirmationModal from\"../../components/ConfirmationModal\";import QrcodeModal from\"../../components/QrcodeModal\";import{i18n}from\"../../translate/i18n\";import{WhatsAppsContext}from\"../../context/WhatsApp/WhatsAppsContext\";import toastError from\"../../errors/toastError\";import ForbiddenPage from\"../../components/ForbiddenPage\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const useStyles=makeStyles(theme=>({mainPaper:_objectSpread({flex:1,padding:theme.spacing(1),overflowY:\"scroll\",borderRadius:\"10px\",boxShadow:\"rgba(0, 0, 0, 0.1) 0px 4px 12px\"},theme.scrollbarStyles),customTableCell:{display:\"flex\",alignItems:\"center\",justifyContent:\"center\"},tooltip:{backgroundColor:\"#f5f5f9\",color:\"rgba(0, 0, 0, 0.87)\",fontSize:theme.typography.pxToRem(14),border:\"1px solid #dadde9\",maxWidth:450},tooltipPopper:{textAlign:\"center\"},buttonProgress:{color:green[500]},TableHead:{backgroundColor:theme.palette.barraSuperior,//\"#3d3d3d\",\ncolor:\"textSecondary\",borderRadius:\"5px\"}}));const CustomToolTip=_ref=>{let{title,content,children}=_ref;const classes=useStyles();return/*#__PURE__*/_jsx(Tooltip,{arrow:true,classes:{tooltip:classes.tooltip,popper:classes.tooltipPopper},title:/*#__PURE__*/_jsxs(React.Fragment,{children:[/*#__PURE__*/_jsx(Typography,{gutterBottom:true,color:\"inherit\",children:title}),content&&/*#__PURE__*/_jsx(Typography,{children:content})]}),children:children});};const IconChannel=channel=>{switch(channel){case\"facebook\":return/*#__PURE__*/_jsx(Facebook,{});case\"instagram\":return/*#__PURE__*/_jsx(Instagram,{});case\"whatsapp\":return/*#__PURE__*/_jsx(WhatsApp,{});default:return\"error\";}};const AllConnections=()=>{const classes=useStyles();const{user,socket}=useContext(AuthContext);const{list}=useCompanies();const[loadingWhatsapp,setLoadingWhatsapp]=useState(true);const[loadingComp,setLoadingComp]=useState(false);const[whats,setWhats]=useState([]);const[whatsAppModalOpen,setWhatsAppModalOpen]=useState(false);const[companies,setCompanies]=useState([]);const[qrModalOpen,setQrModalOpen]=useState(false);const[selectedWhatsApp,setSelectedWhatsApp]=useState(null);const[confirmModalOpen,setConfirmModalOpen]=useState(false);const[filterConnections,setFilterConnections]=useState([]);const[companyWhatsApps,setCompanyWhatsApps]=useState(null);const confirmationModalInitialState={action:\"\",title:\"\",message:\"\",whatsAppId:\"\",open:false};const[confirmModalInfo,setConfirmModalInfo]=useState(confirmationModalInitialState);const history=useHistory();if(!user.super){history.push(\"/tickets\");}useEffect(()=>{setLoadingWhatsapp(true);const fetchSession=async()=>{try{const{data}=await api.get(\"/whatsapp/all/?session=0\");setWhats(data);setLoadingWhatsapp(false);}catch(err){setLoadingWhatsapp(false);toastError(err);}};fetchSession();},[]);const responseFacebook=response=>{if(response.status!==\"unknown\"){const{accessToken,id}=response;api.post(\"/facebook\",{facebookUserId:id,facebookUserToken:accessToken}).then(response=>{toast.success(i18n.t(\"connections.facebook.success\"));}).catch(error=>{toastError(error);});}};useEffect(()=>{loadCompanies();},[]);const loadCompanies=async()=>{setLoadingComp(true);try{const companyList=await list();setCompanies(companyList);}catch(e){toast.error(\"Não foi possível carregar a lista de registros\");}setLoadingComp(false);};const responseInstagram=response=>{if(response.status!==\"unknown\"){const{accessToken,id}=response;api.post(\"/facebook\",{addInstagram:true,facebookUserId:id,facebookUserToken:accessToken}).then(response=>{toast.success(i18n.t(\"connections.facebook.success\"));}).catch(error=>{toastError(error);});}};const handleStartWhatsAppSession=async whatsAppId=>{try{await api.post(\"/whatsappsession/\".concat(whatsAppId));}catch(err){toastError(err);}};const handleRequestNewQrCode=async whatsAppId=>{try{await api.put(\"/whatsappsession/\".concat(whatsAppId));}catch(err){toastError(err);}};const handleOpenWhatsAppModal=(whatsappsFilter,comp)=>{setSelectedWhatsApp(null);setWhatsAppModalOpen(true);if((whatsappsFilter===null||whatsappsFilter===void 0?void 0:whatsappsFilter.length)>0){setFilterConnections(whatsappsFilter);setCompanyWhatsApps(comp);}};const handleCloseWhatsAppModal=useCallback(()=>{setWhatsAppModalOpen(false);setSelectedWhatsApp(null);setFilterConnections([]);setCompanyWhatsApps(null);},[setSelectedWhatsApp,setWhatsAppModalOpen]);const handleOpenQrModal=whatsApp=>{setSelectedWhatsApp(whatsApp);setQrModalOpen(true);};const handleCloseQrModal=useCallback(()=>{setSelectedWhatsApp(null);setQrModalOpen(false);},[setQrModalOpen,setSelectedWhatsApp]);const handleEditWhatsApp=whatsApp=>{setSelectedWhatsApp(whatsApp);setWhatsAppModalOpen(true);};const handleOpenConfirmationModal=(action,whatsAppId)=>{if(action===\"disconnect\"){setConfirmModalInfo({action:action,title:i18n.t(\"connections.confirmationModal.disconnectTitle\"),message:i18n.t(\"connections.confirmationModal.disconnectMessage\"),whatsAppId:whatsAppId});}if(action===\"delete\"){setConfirmModalInfo({action:action,title:i18n.t(\"connections.confirmationModal.deleteTitle\"),message:i18n.t(\"connections.confirmationModal.deleteMessage\"),whatsAppId:whatsAppId});}setConfirmModalOpen(true);};const handleSubmitConfirmationModal=async()=>{if(confirmModalInfo.action===\"disconnect\"){try{await api.delete(\"/whatsappsession/\".concat(confirmModalInfo.whatsAppId));}catch(err){toastError(err);}}if(confirmModalInfo.action===\"delete\"){try{await api.delete(\"/whatsapp/\".concat(confirmModalInfo.whatsAppId));toast.success(i18n.t(\"connections.toasts.deleted\"));}catch(err){toastError(err);}}setConfirmModalInfo(confirmationModalInitialState);};const renderActionButtons=whatsApp=>{return/*#__PURE__*/_jsxs(_Fragment,{children:[whatsApp.status===\"qrcode\"&&/*#__PURE__*/_jsx(Button,{size:\"small\",variant:\"contained\",color:\"primary\",onClick:()=>handleOpenQrModal(whatsApp),children:i18n.t(\"connections.buttons.qrcode\")}),whatsApp.status===\"DISCONNECTED\"&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Button,{size:\"small\",variant:\"outlined\",color:\"primary\",onClick:()=>handleStartWhatsAppSession(whatsApp.id),children:i18n.t(\"connections.buttons.tryAgain\")}),\" \",/*#__PURE__*/_jsx(Button,{size:\"small\",variant:\"outlined\",color:\"secondary\",onClick:()=>handleRequestNewQrCode(whatsApp.id),children:i18n.t(\"connections.buttons.newQr\")})]}),(whatsApp.status===\"CONNECTED\"||whatsApp.status===\"PAIRING\"||whatsApp.status===\"TIMEOUT\")&&/*#__PURE__*/_jsx(Button,{size:\"small\",variant:\"outlined\",color:\"secondary\",onClick:()=>{handleOpenConfirmationModal(\"disconnect\",whatsApp.id);},children:i18n.t(\"connections.buttons.disconnect\")}),whatsApp.status===\"OPENING\"&&/*#__PURE__*/_jsx(Button,{size:\"small\",variant:\"outlined\",disabled:true,color:\"default\",children:i18n.t(\"connections.buttons.connecting\")})]});};const renderStatusToolTips=whatsApp=>{return/*#__PURE__*/_jsxs(\"div\",{className:classes.customTableCell,children:[whatsApp.status===\"DISCONNECTED\"&&/*#__PURE__*/_jsx(CustomToolTip,{title:i18n.t(\"connections.toolTips.disconnected.title\"),content:i18n.t(\"connections.toolTips.disconnected.content\"),children:/*#__PURE__*/_jsx(SignalCellularConnectedNoInternet0Bar,{color:\"secondary\"})}),whatsApp.status===\"OPENING\"&&/*#__PURE__*/_jsx(CircularProgress,{size:24,className:classes.buttonProgress}),whatsApp.status===\"qrcode\"&&/*#__PURE__*/_jsx(CustomToolTip,{title:i18n.t(\"connections.toolTips.qrcode.title\"),content:i18n.t(\"connections.toolTips.qrcode.content\"),children:/*#__PURE__*/_jsx(CropFree,{})}),whatsApp.status===\"CONNECTED\"&&/*#__PURE__*/_jsx(CustomToolTip,{title:i18n.t(\"connections.toolTips.connected.title\"),children:/*#__PURE__*/_jsx(SignalCellular4Bar,{style:{color:green[500]}})}),(whatsApp.status===\"TIMEOUT\"||whatsApp.status===\"PAIRING\")&&/*#__PURE__*/_jsx(CustomToolTip,{title:i18n.t(\"connections.toolTips.timeout.title\"),content:i18n.t(\"connections.toolTips.timeout.content\"),children:/*#__PURE__*/_jsx(SignalCellularConnectedNoInternet2Bar,{color:\"secondary\"})})]});};return/*#__PURE__*/_jsxs(MainContainer,{children:[/*#__PURE__*/_jsx(ConfirmationModal,{title:confirmModalInfo.title,open:confirmModalOpen,onClose:setConfirmModalOpen,onConfirm:handleSubmitConfirmationModal,children:confirmModalInfo.message}),/*#__PURE__*/_jsx(QrcodeModal,{open:qrModalOpen,onClose:handleCloseQrModal,whatsAppId:!whatsAppModalOpen&&(selectedWhatsApp===null||selectedWhatsApp===void 0?void 0:selectedWhatsApp.id)}),/*#__PURE__*/_jsx(WhatsAppModalCompany,{open:whatsAppModalOpen,onClose:handleCloseWhatsAppModal,filteredWhatsapps:filterConnections,companyInfos:companyWhatsApps,whatsAppId:!qrModalOpen&&(selectedWhatsApp===null||selectedWhatsApp===void 0?void 0:selectedWhatsApp.id)}),user.profile===\"user\"?/*#__PURE__*/_jsx(ForbiddenPage,{}):/*#__PURE__*/_jsx(_Fragment,{children:/*#__PURE__*/_jsxs(Paper,{className:classes.mainPaper,style:{overflow:\"hidden\"},variant:\"outlined\",children:[/*#__PURE__*/_jsxs(MainHeader,{children:[/*#__PURE__*/_jsxs(Stack,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"h5\",color:\"black\",style:{fontWeight:\"bold\",marginLeft:\"10px\",marginTop:\"10px\"},gutterBottom:true,children:i18n.t(\"connections.title\")}),/*#__PURE__*/_jsx(Typography,{style:{marginTop:\"-10px\",marginLeft:\"10px\"},variant:\"caption\",color:\"textSecondary\",children:i18n.t(\"connections.connectYourServiceChannelsToReceiveMessagesAndStartConversationsWithYourCustomers\")})]}),/*#__PURE__*/_jsx(MainHeaderButtonsWrapper,{children:/*#__PURE__*/_jsx(PopupState,{variant:\"popover\",popupId:\"demo-popup-menu\",children:popupState=>/*#__PURE__*/_jsx(React.Fragment,{children:/*#__PURE__*/_jsxs(Menu,_objectSpread(_objectSpread({},bindMenu(popupState)),{},{children:[/*#__PURE__*/_jsxs(MenuItem,{onClick:()=>{handleOpenWhatsAppModal();popupState.close();},children:[/*#__PURE__*/_jsx(WhatsApp,{fontSize:\"small\",style:{marginRight:\"10px\"}}),\"WhatsApp\"]}),/*#__PURE__*/_jsx(FacebookLogin,{appId:process.env.REACT_APP_FACEBOOK_APP_ID,autoLoad:false,fields:\"name,email,picture\",version:\"13.0\",scope:\"public_profile,pages_messaging,pages_show_list,pages_manage_metadata,pages_read_engagement,business_management\",callback:responseFacebook,render:renderProps=>/*#__PURE__*/_jsxs(MenuItem,{onClick:renderProps.onClick,children:[/*#__PURE__*/_jsx(Facebook,{fontSize:\"small\",style:{marginRight:\"10px\"}}),\"Facebook\"]})}),/*#__PURE__*/_jsx(FacebookLogin,{appId:process.env.REACT_APP_FACEBOOK_APP_ID,autoLoad:false,fields:\"name,email,picture\",version:\"13.0\",scope:\"public_profile,instagram_basic,instagram_manage_messages,pages_messaging,pages_show_list,pages_manage_metadata,pages_read_engagement,business_management\",callback:responseInstagram,render:renderProps=>/*#__PURE__*/_jsxs(MenuItem,{onClick:renderProps.onClick,children:[/*#__PURE__*/_jsx(Instagram,{fontSize:\"small\",style:{marginRight:\"10px\"}}),\"Instagram\"]})})]}))})})})]}),/*#__PURE__*/_jsx(Stack,{style:{overflowY:\"auto\",padding:\"20px\",backgroundColor:\"rgb(244 244 244 / 53%)\",borderRadius:\"5px\",height:\"93%\"},children:/*#__PURE__*/_jsx(Paper,{children:/*#__PURE__*/_jsxs(Table,{size:\"small\",children:[/*#__PURE__*/_jsx(TableHead,{className:classes.TableHead,children:/*#__PURE__*/_jsxs(TableRow,{style:{color:\"#fff\"},children:[/*#__PURE__*/_jsx(TableCell,{style:{color:\"#fff\"},align:\"center\",children:i18n.t(\"connections.client\")}),/*#__PURE__*/_jsx(TableCell,{style:{color:\"#fff\"},align:\"center\",children:i18n.t(\"connections.connectedConnections\")}),/*#__PURE__*/_jsx(TableCell,{style:{color:\"#fff\"},align:\"center\",children:i18n.t(\"connections.disconnectedConnections\")}),/*#__PURE__*/_jsx(TableCell,{style:{color:\"#fff\"},align:\"center\",children:i18n.t(\"connections.totalConnections\")}),user.profile===\"admin\"&&/*#__PURE__*/_jsx(TableCell,{style:{color:\"#fff\"},align:\"center\",children:i18n.t(\"connections.table.actions\")})]})}),/*#__PURE__*/_jsx(TableBody,{children:loadingWhatsapp?/*#__PURE__*/_jsx(TableRowSkeleton,{}):/*#__PURE__*/_jsxs(_Fragment,{children:[console.log(companies,whats),(companies===null||companies===void 0?void 0:companies.length)>0&&companies.map(company=>/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:company===null||company===void 0?void 0:company.name}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:(whats===null||whats===void 0?void 0:whats.length)&&whats.filter(item=>(item===null||item===void 0?void 0:item.companyId)===(company===null||company===void 0?void 0:company.id)&&(item===null||item===void 0?void 0:item.status)===\"CONNECTED\").length}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:(whats===null||whats===void 0?void 0:whats.length)&&whats.filter(item=>(item===null||item===void 0?void 0:item.companyId)===(company===null||company===void 0?void 0:company.id)&&(item===null||item===void 0?void 0:item.status)!==\"CONNECTED\").length}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:(whats===null||whats===void 0?void 0:whats.length)&&whats.filter(item=>(item===null||item===void 0?void 0:item.companyId)===(company===null||company===void 0?void 0:company.id)).length}),user.profile===\"admin\"&&/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:()=>handleOpenWhatsAppModal(whats.filter(item=>(item===null||item===void 0?void 0:item.companyId)===(company===null||company===void 0?void 0:company.id)),company),children:/*#__PURE__*/_jsx(Edit,{})})})]},company.id)),/*#__PURE__*/_jsxs(TableRow,{className:classes.TableHead,children:[/*#__PURE__*/_jsx(TableCell,{style:{color:\"#fff\"},align:\"center\",children:i18n.t(\"connections.total\")}),/*#__PURE__*/_jsx(TableCell,{style:{color:\"#fff\"},align:\"center\",children:(whats===null||whats===void 0?void 0:whats.length)&&whats.filter(item=>(item===null||item===void 0?void 0:item.status)===\"CONNECTED\").length}),/*#__PURE__*/_jsx(TableCell,{style:{color:\"#fff\"},align:\"center\",children:(whats===null||whats===void 0?void 0:whats.length)&&whats.filter(item=>(item===null||item===void 0?void 0:item.status)!==\"CONNECTED\").length}),/*#__PURE__*/_jsx(TableCell,{style:{color:\"#fff\"},align:\"center\",children:(whats===null||whats===void 0?void 0:whats.length)&&whats.length}),user.profile===\"admin\"&&/*#__PURE__*/_jsx(TableCell,{style:{color:\"#fff\"},align:\"center\"})]})]})})]})})})]})})]});};export default AllConnections;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}