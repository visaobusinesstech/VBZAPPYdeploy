{"ast":null,"code":"import _objectSpread from\"/home/deploy/codigologlow/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useReducer,useContext}from\"react\";import{toast}from\"react-toastify\";import{useHistory}from\"react-router-dom\";// import { SocketContext } from \"../../context/Socket/SocketContext\";\nimport{makeStyles,useTheme}from\"@material-ui/core/styles\";import Paper from\"@material-ui/core/Paper\";import Button from\"@material-ui/core/Button\";import Table from\"@material-ui/core/Table\";import TableBody from\"@material-ui/core/TableBody\";import TableCell from\"@material-ui/core/TableCell\";import TableHead from\"@material-ui/core/TableHead\";import TableRow from\"@material-ui/core/TableRow\";import MainContainer from\"../../components/MainContainer\";import MainHeader from\"../../components/MainHeader\";import Title from\"../../components/Title\";import api from\"../../services/api\";import{i18n}from\"../../translate/i18n\";import TableRowSkeleton from\"../../components/TableRowSkeleton\";import CompanyModal from\"../../components/CompaniesModal\";import ConfirmationModal from\"../../components/ConfirmationModal\";import toastError from\"../../errors/toastError\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{useDate}from\"../../hooks/useDate\";import usePlans from\"../../hooks/usePlans\";import moment from\"moment\";import ColorModeContext from\"../../layout/themeContext\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const reducer=(state,action)=>{if(action.type===\"LOAD_COMPANIES\"){const companies=action.payload;const newCompanies=[];companies.forEach(company=>{const companyIndex=state.findIndex(u=>u.id===company.id);if(companyIndex!==-1){state[companyIndex]=company;}else{newCompanies.push(company);}});return[...state,...newCompanies];}if(action.type===\"UPDATE_COMPANIES\"){const company=action.payload;const companyIndex=state.findIndex(u=>u.id===company.id);if(companyIndex!==-1){state[companyIndex]=company;return[...state];}else{return[company,...state];}}if(action.type===\"DELETE_COMPANIES\"){const companyId=action.payload;const companyIndex=state.findIndex(u=>u.id===companyId);if(companyIndex!==-1){state.splice(companyIndex,1);}return[...state];}if(action.type===\"RESET\"){return[];}};const useStyles=makeStyles(theme=>({mainPaper:_objectSpread({flex:1,padding:theme.spacing(1),overflowY:\"scroll\"},theme.scrollbarStyles)}));const Companies=()=>{const classes=useStyles();const history=useHistory();const[loading,setLoading]=useState(false);const[pageNumber,setPageNumber]=useState(1);const[hasMore,setHasMore]=useState(false);const[selectedCompany,setSelectedCompany]=useState(null);const[deletingCompany,setDeletingCompany]=useState(null);const[companyModalOpen,setCompanyModalOpen]=useState(false);const[confirmModalOpen,setConfirmModalOpen]=useState(false);const[searchParam,setSearchParam]=useState(\"\");const[companies,dispatch]=useReducer(reducer,[]);const{dateToClient,datetimeToClient}=useDate();// const { getPlanCompany } = usePlans();\n//   const socketManager = useContext(SocketContext);\nconst{user,socket}=useContext(AuthContext);const{mode}=useContext(ColorModeContext);const theme=useTheme();useEffect(()=>{async function fetchData(){if(!user.super){toast.error(\"Esta empresa não possui permissão para acessar essa página! Estamos lhe redirecionando.\");setTimeout(()=>{history.push(\"/\");},1000);}}fetchData();// eslint-disable-next-line react-hooks/exhaustive-deps\n},[]);useEffect(()=>{dispatch({type:\"RESET\"});setPageNumber(1);},[searchParam]);useEffect(()=>{setLoading(true);const delayDebounceFn=setTimeout(()=>{const fetchCompanies=async()=>{try{const{data}=await api.get(\"/companiesPlan/\",{params:{searchParam,pageNumber}});dispatch({type:\"LOAD_COMPANIES\",payload:data.companies});setHasMore(data.hasMore);setLoading(false);}catch(err){toastError(err);}};fetchCompanies();},500);return()=>clearTimeout(delayDebounceFn);},[searchParam,pageNumber]);const handleOpenCompanyModal=()=>{setSelectedCompany(null);setCompanyModalOpen(true);};const handleCloseCompanyModal=()=>{setSelectedCompany(null);setCompanyModalOpen(false);};const handleSearch=event=>{setSearchParam(event.target.value.toLowerCase());};const handleEditCompany=company=>{setSelectedCompany(company);setCompanyModalOpen(true);};const handleDeleteCompany=async companyId=>{try{await api.delete(\"/companies/\".concat(companyId));toast.success(i18n.t(\"compaies.toasts.deleted\"));}catch(err){toastError(err);}setDeletingCompany(null);setSearchParam(\"\");setPageNumber(1);};const loadMore=()=>{setPageNumber(prevState=>prevState+1);};const handleScroll=e=>{if(!hasMore||loading)return;const{scrollTop,scrollHeight,clientHeight}=e.currentTarget;if(scrollHeight-(scrollTop+100)<clientHeight){loadMore();}};const renderStatus=row=>{return row.status===false?\"Não\":\"Sim\";};const renderPlanValue=row=>{return row.planId!==null?row.plan.amount?row.plan.amount.toLocaleString(\"pt-br\",{minimumFractionDigits:2}):\"00.00\":\"-\";};const renderWhatsapp=row=>{return row.useWhatsapp===false?\"Não\":\"Sim\";};const renderFacebook=row=>{return row.useFacebook===false?\"Não\":\"Sim\";};const renderInstagram=row=>{return row.useInstagram===false?\"Não\":\"Sim\";};const renderCampaigns=row=>{return row.useCampaigns===false?\"Não\":\"Sim\";};const renderSchedules=row=>{return row.useSchedules===false?\"Não\":\"Sim\";};const renderInternalChat=row=>{return row.useInternalChat===false?\"Não\":\"Sim\";};const renderExternalApi=row=>{return row.useExternalApi===false?\"Não\":\"Sim\";};const rowStyle=record=>{if(moment(record.dueDate).isValid()){const now=moment();const dueDate=moment(record.dueDate);const diff=dueDate.diff(now,\"days\");if(diff>=1&&diff<=5){return{backgroundColor:\"#fffead\"};}if(diff<=0){return{backgroundColor:\"#fa8c8c\"};}}return{};};const cellStyle=record=>{if(moment(record.dueDate).isValid()){const now=moment();const dueDate=moment(record.dueDate);const diff=dueDate.diff(now,\"days\");if(diff>=1&&diff<=5){return{color:\"#000\"};}if(diff<=0){return{color:\"#fff\"};}}return{};};const formatFolderSize=size=>{if(!size||size===0)return'0 Bytes';const units=['Bytes','KB','MB','GB','TB'];let index=0;let formattedSize=size;while(formattedSize>=1024&&index<units.length-1){formattedSize/=1024;index++;}return\"\".concat(formattedSize.toFixed(2),\" \").concat(units[index]);};return/*#__PURE__*/_jsxs(MainContainer,{children:[/*#__PURE__*/_jsx(ConfirmationModal,{title:deletingCompany&&\"\".concat(i18n.t(\"compaies.confirmationModal.deleteTitle\"),\" \").concat(deletingCompany.name,\"?\"),open:confirmModalOpen,onClose:setConfirmModalOpen,onConfirm:()=>handleDeleteCompany(deletingCompany.id),children:i18n.t(\"compaies.confirmationModal.deleteMessage\")}),/*#__PURE__*/_jsx(CompanyModal,{open:companyModalOpen,onClose:handleCloseCompanyModal,\"aria-labelledby\":\"form-dialog-title\",companyId:selectedCompany&&selectedCompany.id}),/*#__PURE__*/_jsx(MainHeader,{children:/*#__PURE__*/_jsxs(Title,{children:[i18n.t(\"compaies.title\"),\" (\",companies.length,\")\"]})}),/*#__PURE__*/_jsx(Paper,{className:classes.mainPaper,variant:\"outlined\",onScroll:handleScroll,children:/*#__PURE__*/_jsxs(Table,{size:\"small\",children:[/*#__PURE__*/_jsx(TableHead,{children:/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"compaies.table.ID\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"compaies.table.status\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"compaies.table.name\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"compaies.table.email\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"compaies.table.namePlan\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"compaies.table.value\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"compaies.table.createdAt\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"compaies.table.dueDate\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"compaies.table.lastLogin\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"compaies.table.folderSize\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"compaies.table.totalFiles\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"compaies.table.lastUpdate\")})]})}),/*#__PURE__*/_jsx(TableBody,{children:/*#__PURE__*/_jsxs(_Fragment,{children:[companies.map(company=>{var _company$plan,_company$metrics,_company$metrics2,_company$metrics3;return/*#__PURE__*/_jsxs(TableRow,{style:rowStyle(company),children:[/*#__PURE__*/_jsx(TableCell,{style:cellStyle(company),align:\"center\",children:company.id}),/*#__PURE__*/_jsx(TableCell,{style:cellStyle(company),align:\"center\",children:renderStatus(company.status)}),/*#__PURE__*/_jsx(TableCell,{style:cellStyle(company),align:\"center\",children:company.name}),/*#__PURE__*/_jsx(TableCell,{style:cellStyle(company),align:\"center\",children:company.email}),/*#__PURE__*/_jsx(TableCell,{style:cellStyle(company),align:\"center\",children:company===null||company===void 0?void 0:(_company$plan=company.plan)===null||_company$plan===void 0?void 0:_company$plan.name}),/*#__PURE__*/_jsxs(TableCell,{style:cellStyle(company),align:\"center\",children:[\"R$ \",renderPlanValue(company)]}),/*#__PURE__*/_jsx(TableCell,{style:cellStyle(company),align:\"center\",children:dateToClient(company.createdAt)}),/*#__PURE__*/_jsxs(TableCell,{style:cellStyle(company),align:\"center\",children:[dateToClient(company.dueDate),/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(\"span\",{style:cellStyle(company),children:company.recurrence})]}),/*#__PURE__*/_jsx(TableCell,{style:cellStyle(company),align:\"center\",children:datetimeToClient(company.lastLogin)}),/*#__PURE__*/_jsx(TableCell,{style:cellStyle(company),align:\"center\",children:formatFolderSize((company===null||company===void 0?void 0:(_company$metrics=company.metrics)===null||_company$metrics===void 0?void 0:_company$metrics.folderSize)||0)}),/*#__PURE__*/_jsx(TableCell,{style:cellStyle(company),align:\"center\",children:(company===null||company===void 0?void 0:(_company$metrics2=company.metrics)===null||_company$metrics2===void 0?void 0:_company$metrics2.numberOfFiles)||0}),/*#__PURE__*/_jsx(TableCell,{style:cellStyle(company),align:\"center\",children:datetimeToClient((company===null||company===void 0?void 0:(_company$metrics3=company.metrics)===null||_company$metrics3===void 0?void 0:_company$metrics3.lastUpdate)||'Não disponível')})]},company.id);}),loading&&/*#__PURE__*/_jsx(TableRowSkeleton,{columns:4})]})})]})})]});};export default Companies;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}