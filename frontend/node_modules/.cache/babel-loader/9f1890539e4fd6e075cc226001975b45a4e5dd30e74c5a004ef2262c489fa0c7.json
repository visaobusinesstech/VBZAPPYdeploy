{"ast":null,"code":"// src/components/TriggerFlowModal/index.js\nimport React,{useState,useEffect}from\"react\";import{Dialog,DialogTitle,DialogContent,DialogActions,Button,FormControl,InputLabel,Select,MenuItem,CircularProgress,Typography,Box,makeStyles}from\"@material-ui/core\";import{green}from\"@material-ui/core/colors\";import{i18n}from\"../../translate/i18n\";import toastError from\"../../errors/toastError\";import{toast}from\"react-toastify\";import api from\"../../services/api\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const useStyles=makeStyles(theme=>({dialogPaper:{minWidth:400},formControl:{minWidth:\"100%\",marginBottom:theme.spacing(2)},loadingWrapper:{display:\"flex\",justifyContent:\"center\",alignItems:\"center\",minHeight:200},flowDescription:{marginTop:theme.spacing(1),color:theme.palette.text.secondary,fontSize:\"0.875rem\"},noFlowsMessage:{textAlign:\"center\",color:theme.palette.text.secondary,padding:theme.spacing(2)},successIcon:{color:green[500],marginRight:theme.spacing(1)}}));const TriggerFlowModal=_ref=>{let{open,onClose,ticketId,ticketStatus,onFlowTriggered,onFlowProcessing}=_ref;const classes=useStyles();const[flows,setFlows]=useState([]);const[selectedFlow,setSelectedFlow]=useState(\"\");const[loading,setLoading]=useState(false);const[loadingFlows,setLoadingFlows]=useState(true);// Carregar fluxos disponÃ­veis\nuseEffect(()=>{const fetchFlows=async()=>{if(!open)return;setLoadingFlows(true);try{const response=await api.get(\"/flowbuilder\");// A resposta tem a estrutura: { flows: [...] }\nconst flowsData=response.data.flows||[];console.log(\"Resposta da API flowbuilder:\",flowsData);// Filtrar apenas fluxos ativos\nconst activeFlows=flowsData.filter(flow=>flow.active===true);setFlows(activeFlows);console.log(\"Fluxos ativos encontrados:\",activeFlows);}catch(error){console.error(\"Erro ao carregar fluxos:\",error);toastError(\"Erro ao carregar fluxos disponÃ­veis\");}finally{setLoadingFlows(false);}};fetchFlows();},[open]);// Reset ao abrir/fechar modal\nuseEffect(()=>{if(open){setSelectedFlow(\"\");}},[open]);// âœ… NOVO: Informar o componente pai sobre o estado de processamento\nuseEffect(()=>{if(onFlowProcessing){onFlowProcessing(loading);}},[loading,onFlowProcessing]);const handleFlowChange=event=>{setSelectedFlow(event.target.value);};const handleTriggerFlow=async()=>{if(!selectedFlow){toast.warning(\"Selecione um fluxo para disparar\");return;}setLoading(true);try{console.log(\"ðŸŽ¯ Disparando fluxo:\",selectedFlow,\"para ticket:\",ticketId);const response=await api.post(\"/tickets/\".concat(ticketId,\"/trigger-flow\"),{flowId:selectedFlow});if(response.data.success){toast.success(\"Fluxo disparado com sucesso!\");console.log(\"âœ… Fluxo disparado com sucesso:\",response.data.data);// Callback para notificar o componente pai\nif(onFlowTriggered){onFlowTriggered(response.data.data);}onClose();}}catch(error){var _error$response,_error$response$data;console.error(\"âŒ Erro ao disparar fluxo:\",error);const errorMessage=((_error$response=error.response)===null||_error$response===void 0?void 0:(_error$response$data=_error$response.data)===null||_error$response$data===void 0?void 0:_error$response$data.error)||\"Erro ao disparar fluxo\";toastError(errorMessage);}finally{setLoading(false);}};const handleClose=()=>{if(!loading){onClose();}};const getSelectedFlowInfo=()=>{if(!selectedFlow)return null;return flows.find(flow=>flow.id===selectedFlow);};const selectedFlowInfo=getSelectedFlowInfo();return/*#__PURE__*/_jsxs(Dialog,{open:open,onClose:handleClose,maxWidth:\"sm\",fullWidth:true,classes:{paper:classes.dialogPaper},children:[/*#__PURE__*/_jsx(DialogTitle,{children:i18n.t(\"triggerFlowModal.title\")}),/*#__PURE__*/_jsx(DialogContent,{children:loadingFlows?/*#__PURE__*/_jsx(\"div\",{className:classes.loadingWrapper,children:/*#__PURE__*/_jsx(CircularProgress,{})}):flows.length===0?/*#__PURE__*/_jsx(\"div\",{className:classes.noFlowsMessage,children:/*#__PURE__*/_jsx(Typography,{variant:\"body1\",children:i18n.t(\"triggerFlowModal.noFlows\")})}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"body2\",color:\"textSecondary\",gutterBottom:true,children:i18n.t(\"triggerFlowModal.description\")}),/*#__PURE__*/_jsxs(FormControl,{className:classes.formControl,children:[/*#__PURE__*/_jsx(InputLabel,{id:\"flow-select-label\",children:i18n.t(\"triggerFlowModal.selectFlow\")}),/*#__PURE__*/_jsx(Select,{labelId:\"flow-select-label\",value:selectedFlow,onChange:handleFlowChange,disabled:loading,children:flows.map(flow=>/*#__PURE__*/_jsx(MenuItem,{value:flow.id,children:flow.name},flow.id))})]}),selectedFlowInfo&&/*#__PURE__*/_jsxs(Box,{className:classes.flowDescription,children:[/*#__PURE__*/_jsxs(Typography,{variant:\"caption\",display:\"block\",children:[/*#__PURE__*/_jsxs(\"strong\",{children:[i18n.t(\"triggerFlowModal.selectedFlow\"),\":\"]}),\" \",selectedFlowInfo.name]}),/*#__PURE__*/_jsxs(Typography,{variant:\"caption\",display:\"block\",children:[/*#__PURE__*/_jsxs(\"strong\",{children:[i18n.t(\"triggerFlowModal.flowId\"),\":\"]}),\" \",selectedFlowInfo.id]})]}),loading&&/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",justifyContent:\"center\",mt:2,p:2,bgcolor:\"action.hover\",borderRadius:1,children:[/*#__PURE__*/_jsx(CircularProgress,{size:20,style:{marginRight:8}}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",color:\"textSecondary\",children:\"Disparando fluxo... Campo de mensagem temporariamente desabilitado.\"})]})]})}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:handleClose,color:\"secondary\",disabled:loading,children:i18n.t(\"triggerFlowModal.cancel\")}),/*#__PURE__*/_jsx(Button,{onClick:handleTriggerFlow,color:\"primary\",variant:\"contained\",disabled:loading||!selectedFlow||loadingFlows||flows.length===0,startIcon:loading&&/*#__PURE__*/_jsx(CircularProgress,{size:20}),children:loading?i18n.t(\"triggerFlowModal.triggering\"):i18n.t(\"triggerFlowModal.trigger\")})]})]});};export default TriggerFlowModal;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}