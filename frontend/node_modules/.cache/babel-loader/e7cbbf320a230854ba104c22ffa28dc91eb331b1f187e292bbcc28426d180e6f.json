{"ast":null,"code":"import _objectSpread from\"/home/deploy/atendechatop/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useContext,useEffect,useRef,useState}from\"react\";import{useParams,useHistory}from\"react-router-dom\";import{Button,Dialog,DialogActions,DialogContent,DialogTitle,Grid,makeStyles,Paper,Tab,Tabs,TextField,Chip,Typography,FormControl,InputLabel,Select,MenuItem,Badge,Avatar,IconButton}from\"@material-ui/core\";import ChatList from\"./ChatList\";import ChatMessages from\"./ChatMessages\";import{UsersFilter}from\"../../components/UsersFilter\";import api from\"../../services/api\";import useResponsive from\"../../utils/useResponsive\";import{socketConnection}from\"../../services/socket\";import{has,isObject}from\"lodash\";import{getBackendUrl}from\"../../config\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{i18n}from\"../../translate/i18n\";import{toast}from\"react-hot-toast\";import ArrowBackIcon from\"@material-ui/icons/ArrowBack\";// FIXME checkout https://mui.com/components/use-media-query/#migrating-from-withwidth\nimport{jsx as _jsx,Fragment as _Fragment,jsxs as _jsxs}from\"react/jsx-runtime\";const withWidth=()=>WrappedComponent=>props=>/*#__PURE__*/_jsx(WrappedComponent,_objectSpread(_objectSpread({},props),{},{width:\"xs\"}));const useStyles=makeStyles(theme=>({mainContainer:{display:\"flex\",flexDirection:\"column\",position:\"relative\",flex:1,padding:theme.spacing(2),height:\"calc(100% - 48px)\",overflowY:\"hidden\",border:\"1px solid rgba(0, 0, 0, 0.12)\"},gridContainer:{flex:1,height:\"100%\",border:\"1px solid rgba(0, 0, 0, 0.12)\",background:theme.palette.background.color},gridItem:{height:\"100%\"},gridItemTab:{height:\"92%\",width:\"100%\"},btnContainer:{textAlign:\"right\",padding:10}}));export function ChatModal(_ref){let{open,chat,type,handleClose,handleLoadNewChat,findChats,setChats,setChatsPageInfo,chats,loggedInUserId}=_ref;const[users,setUsers]=useState([]);const[title,setTitle]=useState(\"\");const[description,setDescription]=useState(\"\");const[groupImage,setGroupImage]=useState(\"\");const[imageFile,setImageFile]=useState(null);useEffect(()=>{if(open){setTitle(\"\");setUsers([]);setDescription(\"\");setGroupImage(\"\");setImageFile(null);if(type===\"edit\"&&chat&&chat.users){const userList=chat.users.map(u=>({id:u.user.id,name:u.user.name}));setUsers(userList);setTitle(chat.title||\"\");setDescription(chat.description||\"\");if(chat.groupImage){setGroupImage(chat.groupImage);}}}},[chat,open,type]);// const handleImageChange = (e) => {\n//   if (e.target.files && e.target.files[0]) {\n//     setImageFile(e.target.files[0]);\n//     setGroupImage(URL.createObjectURL(e.target.files[0]));\n//   }\n// };\nconst handleImageChange=e=>{if(e.target.files&&e.target.files[0]){const file=e.target.files[0];const previewUrl=URL.createObjectURL(file);setImageFile(file);setGroupImage(previewUrl);console.log(\"Preview URL:\",previewUrl);}};const handleSave=async()=>{try{let uploadedImageUrl=groupImage;if(imageFile){const formData=new FormData();formData.append(\"file\",imageFile);const uploadRes=await api.post(\"/chats/upload\",formData,{headers:{\"Content-Type\":\"multipart/form-data\"}});uploadedImageUrl=uploadRes.data.url;}if(type===\"edit\"&&chat){const{data}=await api.put(\"/chats/\".concat(chat.id),{users,title,description,groupImage:uploadedImageUrl});handleLoadNewChat(data);}else{const isCreatingGroup=users.length>1||title!==\"\";console.log(\"isCreatingGroup:\",isCreatingGroup);if(!isCreatingGroup){var _users$;const selectedUserId=(_users$=users[0])===null||_users$===void 0?void 0:_users$.id;console.log(\"selectedUserId:\",selectedUserId);console.log(\"loggedInUserId:\",loggedInUserId);console.log(\"chats available:\",chats);const existingChat=chats.find(c=>{const hasSelectedUser=c.users.some(u=>u.userId===selectedUserId);const hasLoggedInUser=c.users.some(u=>u.userId===loggedInUserId);const isIndividualChat=!c.isGroup&&c.users.length===2;console.log(\"Checking chat \".concat(c.id,\": isIndividualChat=\").concat(isIndividualChat,\", hasSelectedUser=\").concat(hasSelectedUser,\", hasLoggedInUser=\").concat(hasLoggedInUser));return isIndividualChat&&hasSelectedUser&&hasLoggedInUser;});console.log(\"Found existingChat:\",existingChat);if(existingChat){toast.info(\"Chat com este usuário já existe!\");handleLoadNewChat(existingChat);handleClose();return;}}const{data}=await api.post(\"/chats\",{users,title,description,groupImage:uploadedImageUrl,isGroup:isCreatingGroup});handleLoadNewChat(data);}handleClose();}catch(err){console.error(err);toast.error(\"Erro ao criar/editar chat\");}};return/*#__PURE__*/_jsxs(Dialog,{open:open,onClose:handleClose,\"aria-labelledby\":\"alert-dialog-title\",\"aria-describedby\":\"alert-dialog-description\",children:[/*#__PURE__*/_jsx(DialogTitle,{id:\"alert-dialog-title\",children:type===\"edit\"?i18n.t(\"chatIndex.modal.editTitle\")||\"Editar Grupo\":i18n.t(\"chatIndex.modal.title\")||\"Criar Grupo\"}),/*#__PURE__*/_jsx(DialogContent,{children:/*#__PURE__*/_jsxs(Grid,{spacing:2,container:true,children:[/*#__PURE__*/_jsxs(Grid,{xs:12,style:{padding:18,textAlign:\"center\"},item:true,children:[/*#__PURE__*/_jsx(\"input\",{accept:\"image/*\",style:{display:\"none\"},id:\"group-image-upload\",type:\"file\",onChange:handleImageChange}),/*#__PURE__*/_jsx(\"label\",{htmlFor:\"group-image-upload\",children:/*#__PURE__*/_jsx(Button,{variant:\"outlined\",color:\"primary\",component:\"span\",children:groupImage?\"Alterar Foto do Grupo\":\"Adicionar Foto do Grupo\"})}),groupImage&&/*#__PURE__*/_jsx(_Fragment,{children:/*#__PURE__*/_jsx(\"div\",{style:{marginTop:10},children:/*#__PURE__*/_jsx(\"img\",{src:typeof groupImage===\"string\"?groupImage.startsWith(\"http\")||groupImage.startsWith(\"blob:\")?groupImage:\"\".concat(getBackendUrl()).concat(groupImage):URL.createObjectURL(groupImage),alt:\"Group\",style:{width:80,height:80,borderRadius:\"50%\",objectFit:\"cover\"}})})})]}),/*#__PURE__*/_jsx(Grid,{xs:12,style:{padding:18},item:true,children:/*#__PURE__*/_jsx(TextField,{label:\"T\\xEDtulo\",placeholder:\"T\\xEDtulo\",value:title,onChange:e=>setTitle(e.target.value),variant:\"outlined\",size:\"small\",fullWidth:true})}),/*#__PURE__*/_jsx(Grid,{xs:12,style:{padding:18},item:true,children:/*#__PURE__*/_jsx(TextField,{label:\"Descri\\xE7\\xE3o\",placeholder:\"Descri\\xE7\\xE3o do grupo\",value:description,onChange:e=>setDescription(e.target.value),variant:\"outlined\",size:\"small\",fullWidth:true,multiline:true,rows:2})}),/*#__PURE__*/_jsx(Grid,{xs:12,item:true,children:/*#__PURE__*/_jsx(UsersFilter,{onFiltered:users=>setUsers(users),initialUsers:users})})]})}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:handleClose,color:\"primary\",children:i18n.t(\"chatIndex.modal.cancel\")}),/*#__PURE__*/_jsx(Button,{onClick:handleSave,color:\"primary\",variant:\"contained\",disabled:users===undefined||users.length===0||title===null||title===\"\"||title===undefined,children:i18n.t(\"chatIndex.modal.save\")})]})]});}function Chat(props){const classes=useStyles();const{user}=useContext(AuthContext);const history=useHistory();const[showDialog,setShowDialog]=useState(false);const[dialogType,setDialogType]=useState(\"new\");const[currentChat,setCurrentChat]=useState({});const[chats,setChats]=useState([]);const[chatsPageInfo,setChatsPageInfo]=useState({hasMore:false});const[messages,setMessages]=useState([]);const[messagesPageInfo,setMessagesPageInfo]=useState({hasMore:false});const[messagesPage,setMessagesPage]=useState(1);const[loading,setLoading]=useState(false);const[loadingMore,setLoadingMore]=useState(false);const[tab,setTab]=useState(0);const[showGroupChats,setShowGroupChats]=useState(false);const isMounted=useRef(true);const scrollToBottomRef=useRef();const messageListRef=useRef();const{id}=useParams();const isMdUp=useResponsive();const[editModalOpen,setEditModalOpen]=useState(false);const[deleteModalOpen,setDeleteModalOpen]=useState(false);const[forwardModalOpen,setForwardModalOpen]=useState(false);const[selectedMessage,setSelectedMessage]=useState(null);const[editText,setEditText]=useState(\"\");const[selectedChatForForward,setSelectedChatForForward]=useState(null);const[justOpenedChat,setJustOpenedChat]=useState(false);// Definir socket e companyId no escopo da função\nconst companyId=user===null||user===void 0?void 0:user.companyId;const socket=companyId?socketConnection({companyId,userId:user===null||user===void 0?void 0:user.id}):null;// Monitorar mudanças no estado chats\nuseEffect(()=>{const groups=chats.filter(chat=>chat.isGroup===true||chat.isGroup===\"true\");const individualChats=chats.filter(chat=>!(chat.isGroup===true||chat.isGroup===\"true\"));},[chats,showGroupChats]);useEffect(()=>{return()=>{isMounted.current=false;};},[]);useEffect(()=>{if(isMounted.current&&user!==null&&user!==void 0&&user.id){findChats().then(data=>{const{records}=data;console.log(\"Chats encontrados:\",records.length);if(isMounted.current&&records.length>0){setChats(records);setChatsPageInfo(data);if(id&&records.length){const chat=records.find(r=>r.uuid===id);if(chat){selectChat(chat,\"useEffect[user?.id] (carregar chats iniciais)\");}}}else{console.log(\"Nenhum chat encontrado ou componente desmontado\");}}).catch(err=>{console.error(\"Erro ao carregar chats iniciais:\",err);});}else{console.log(\"Componente não montado ou usuário não disponível\");}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[user===null||user===void 0?void 0:user.id]);useEffect(()=>{if(!user.id)return;const onChatUser=data=>{if(isMounted.current){if(data.action===\"create\"){setChats(prev=>[data.record,...prev]);}if(data.action===\"update\"){setChats(prev=>prev.map(chat=>chat.id===data.record.id?_objectSpread(_objectSpread({},chat),data.record):chat));if(currentChat&&currentChat.id===data.record.id){setCurrentChat(data.record);}}}};const onChat=data=>{if(!isMounted.current)return;if(isMounted.current){if(data.action===\"delete\"){setChats(prev=>prev.filter(c=>c.id!==+data.id));setMessages([]);setMessagesPage(1);setMessagesPageInfo({hasMore:false});setCurrentChat({});history.push(\"/chats\");setTab(0);}if(data.action===\"new-message\"||data.action===\"update\"){// Só atualize se NÃO for o chat atualmente aberto\nif(!currentChat||currentChat.id!==data.chat.id){setChats(prev=>prev.map(chat=>chat.id===data.chat.id?_objectSpread(_objectSpread({},chat),data.chat):chat));}}}};if(socket&&companyId){socket.on(\"company-\".concat(companyId,\"-chat-user-\").concat(user.id),onChatUser);socket.on(\"company-\".concat(companyId,\"-chat\"),onChat);return()=>{socket.off(\"company-\".concat(companyId,\"-chat-user-\").concat(user.id),onChatUser);socket.off(\"company-\".concat(companyId,\"-chat\"),onChat);};}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[user,socket,companyId]);useEffect(()=>{if(isObject(currentChat)&&has(currentChat,\"id\")&&socket&&companyId){const onCurrentChat=data=>{if(isMounted.current){if(data.action===\"new-message\"){setMessages(prev=>{// Remove mensagem otimista (temp) com mesmo conteúdo e usuário\nconst filtered=prev.filter(msg=>{var _msg$id;return!((_msg$id=msg.id)!==null&&_msg$id!==void 0&&_msg$id.toString().startsWith(\"temp-\")&&msg.senderId===data.newMessage.senderId&&msg.message===data.newMessage.message);});// Evita duplicidade da real\nif(filtered.some(msg=>msg.id===data.newMessage.id)){return filtered;}return[...filtered,data.newMessage];});const changedChats=chats.map(chat=>{if(chat.id===data.newMessage.chatId){return _objectSpread(_objectSpread(_objectSpread({},chat),data.chat),{},{lastMessage:data.newMessage,updatedAt:data.newMessage.createdAt});}return chat;});setChats(changedChats);if(typeof scrollToBottomRef.current===\"function\"){setTimeout(()=>{scrollToBottomRef.current();},300);}// NÃO altere setMessagesPage aqui!\n}else if(data.action===\"edit-message\"){setMessages(prevMessages=>prevMessages.map(msg=>msg.id===data.message.id?data.message:msg));}else if(data.action===\"delete-message\"){setMessages(prevMessages=>prevMessages.map(msg=>msg.id===data.message.id?data.message:msg));}if(data.action===\"update\"){const changedChats=chats.map(chat=>{if(chat.id===data.chat.id){return _objectSpread(_objectSpread({},chat),data.chat);}return chat;});setChats(changedChats);if(typeof scrollToBottomRef.current===\"function\"){scrollToBottomRef.current();}}}};socket.on(\"company-\".concat(companyId,\"-chat-\").concat(currentChat.id),onCurrentChat);return()=>{socket.off(\"company-\".concat(companyId,\"-chat-\").concat(currentChat.id),onCurrentChat);};}},[currentChat,chats,companyId,socket]);// Modifique selectChat para buscar apenas a primeira página ao abrir o chat\nconst selectChat=async function(chat){let reason=arguments.length>1&&arguments[1]!==undefined?arguments[1]:\"manual\";console.log(\"[selectChat] Motivo: \".concat(reason),chat);if(!isMounted.current)return;setMessages([]);setMessagesPage(1);setMessagesPageInfo(null);setJustOpenedChat(true);try{// Buscar chat atualizado do backend usando UUID\nconst{data}=await api.get(\"/chats/\".concat(chat.uuid));if(!isMounted.current)return;setCurrentChat(data);// Buscar apenas a primeira página de mensagens\nawait findMessages(data.id,false,1);// Passa página 1 explicitamente\n}catch(err){if(!isMounted.current)return;setCurrentChat(chat);await findMessages(chat.id,false,1);}};// No sendMessage, garanta que NENHUM findMessages, selectChat ou loadMoreMessages é chamado após o envio.\nconst sendMessage=async contentMessage=>{if(!currentChat||!currentChat.id){console.error(\"Nenhum chat selecionado para enviar mensagem\");return;}setLoading(true);try{await api.post(\"/chats/\".concat(currentChat.id,\"/messages\"),{message:contentMessage});// Não chame findMessages, selectChat ou loadMoreMessages aqui!\n// Apenas limpe o campo de input, a mensagem será adicionada pelo socket\n}catch(err){console.error(\"Erro ao enviar mensagem:\",err);}setLoading(false);};const deleteChat=async chat=>{try{await api.delete(\"/chats/\".concat(chat.id));}catch(err){}};// Modifique findMessages para aceitar página explicitamente\nconst findMessages=async function(chatId){let isLoadMore=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;let page=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(!isMounted.current||!chatId)return;if(isLoadMore){setLoadingMore(true);}else{setLoading(true);}let currentScrollHeight=0;let currentScrollTop=0;if(isLoadMore){const messageListElement=document.querySelector(\".messageList\");currentScrollHeight=(messageListElement===null||messageListElement===void 0?void 0:messageListElement.scrollHeight)||0;currentScrollTop=(messageListElement===null||messageListElement===void 0?void 0:messageListElement.scrollTop)||0;}try{const pageToFetch=page!==null?page:messagesPage;const url=\"/chats/\".concat(chatId,\"/messages?pageNumber=\").concat(pageToFetch);const{data}=await api.get(url);if(!isMounted.current)return;if(isMounted.current){const isFirstPage=pageToFetch===1;if(isLoadMore){setMessagesPage(prev=>prev+1);}setMessagesPageInfo(data);if(isFirstPage){setMessages(data.records);}else{setMessages(prev=>[...data.records,...prev]);if(isLoadMore){setTimeout(()=>{if(!isMounted.current)return;const messageListElement=document.querySelector(\".messageList\");if(messageListElement){const newScrollHeight=messageListElement.scrollHeight;const scrollDifference=newScrollHeight-currentScrollHeight;messageListElement.scrollTop=currentScrollTop+scrollDifference;}},100);}}}}catch(err){if(!isMounted.current)return;console.error(\"Erro ao carregar mensagens:\",err);}finally{if(isMounted.current){if(isLoadMore){setLoadingMore(false);}else{setLoading(false);}}}};const loadMoreMessages=async()=>{if(!loadingMore&&currentChat&&currentChat.id&&messagesPageInfo!==null&&messagesPageInfo!==void 0&&messagesPageInfo.hasMore){await findMessages(currentChat.id,true);// Não passe page aqui!\n}};const findChats=async()=>{if(!isMounted.current)return;setLoading(true);try{const{data}=await api.get(\"/chats\");// Contar grupos e chats individuais\nconst groups=data.records.filter(chat=>chat.isGroup===true||chat.isGroup===\"true\");const individualChats=data.records.filter(chat=>!(chat.isGroup===true||chat.isGroup===\"true\"));if(isMounted.current){setChats(data.records);setChatsPageInfo(data);console.log(\"Chats definidos no estado\");}return data;}catch(err){console.log(\"Erro ao carregar chats:\",err);return{records:[],hasMore:false};}finally{if(isMounted.current){setLoading(false);}}};const handleLoadNewChat=data=>{if(!isMounted.current)return;// Limpar estado anterior\nsetMessages([]);setMessagesPage(1);setMessagesPageInfo(null);setCurrentChat(data);setJustOpenedChat(true);// Ativar scroll automático\n// No mobile, não mudar a tab automaticamente\n// Deixar o usuário escolher qual tab usar\nhistory.push(\"/chats/\".concat(data.uuid));// Não chame findMessages aqui, selectChat já faz isso\nselectChat(data,\"handleLoadNewChat (novo chat criado/editado)\");// Atualiza a lista de chats\nfindChats().then(chatsData=>{if(isMounted.current&&chatsData&&chatsData.records){setChats(chatsData.records);setChatsPageInfo(chatsData);}});};const handleEditMessage=message=>{// Regra: só pode editar em até 10 minutos\nif(new Date()-new Date(message.createdAt)>10*60*1000){alert(\"Só é possível editar mensagens enviadas há menos de 10 minutos.\");return;}setSelectedMessage(message);setEditText(message.message);setEditModalOpen(true);};const handleDeleteMessage=message=>{setSelectedMessage(message);setDeleteModalOpen(true);};const handleEditSubmit=async()=>{try{const{data}=await api.put(\"/chats/messages/\".concat(selectedMessage.id),{message:editText});setMessages(prevMessages=>prevMessages.map(msg=>msg.id===selectedMessage.id?_objectSpread(_objectSpread({},msg),{},{message:editText}):msg));setEditModalOpen(false);setSelectedMessage(null);setEditText(\"\");}catch(err){console.error(err);}};const handleDeleteSubmit=async()=>{try{await api.delete(\"/chats/messages/\".concat(selectedMessage.id));setMessages(prevMessages=>prevMessages.map(msg=>msg.id===selectedMessage.id?_objectSpread(_objectSpread({},msg),{},{isDeleted:true,message:\"Esta mensagem foi apagada\",mediaPath:null,forwardedFrom:null,replyTo:null}):msg));setDeleteModalOpen(false);setSelectedMessage(null);}catch(err){console.error(err);}};const handleForwardMessage=message=>{setSelectedMessage(message);setForwardModalOpen(true);};const handleForwardSubmit=async()=>{try{await api.post(\"/chats/messages/\".concat(selectedMessage.id,\"/forward\"),{targetChatId:selectedChatForForward});setForwardModalOpen(false);setSelectedMessage(null);setSelectedChatForForward(null);}catch(err){console.error(err);}};const renderGrid=()=>{const filteredChats=chats.filter(chat=>{const isGroup=chat.isGroup===true||chat.isGroup===\"true\";const shouldShow=showGroupChats?isGroup:!isGroup;return shouldShow;}).sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));return/*#__PURE__*/_jsxs(Grid,{className:classes.gridContainer,container:true,children:[/*#__PURE__*/_jsxs(Grid,{className:classes.gridItem,md:3,item:true,children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",gap:8,marginBottom:12},children:[/*#__PURE__*/_jsx(Button,{onClick:()=>setShowGroupChats(false),color:!showGroupChats?\"primary\":\"default\",variant:!showGroupChats?\"contained\":\"outlined\",fullWidth:true,children:i18n.t(\"chatIndex.chats\")}),/*#__PURE__*/_jsx(Button,{onClick:()=>setShowGroupChats(true),color:showGroupChats?\"primary\":\"default\",variant:showGroupChats?\"contained\":\"outlined\",fullWidth:true,children:i18n.t(\"chatIndex.groups\")}),/*#__PURE__*/_jsx(Button,{onClick:()=>{setDialogType(\"new\");setShowDialog(true);},color:\"secondary\",variant:\"contained\",fullWidth:true,children:i18n.t(\"chatIndex.createGroup\")})]}),/*#__PURE__*/_jsx(ChatList,{chats:filteredChats,pageInfo:chatsPageInfo,loading:loading,handleSelectChat:chat=>selectChat(chat,\"seleção manual na lista\"),handleDeleteChat:chat=>deleteChat(chat),handleEditChat:chat=>{setCurrentChat(chat);setDialogType(\"edit\");setShowDialog(true);},findChats:findChats})]}),/*#__PURE__*/_jsx(Grid,{className:classes.gridItem,md:9,item:true,children:isObject(currentChat)&&has(currentChat,\"id\")&&/*#__PURE__*/_jsx(ChatMessages,{chat:currentChat,scrollToBottomRef:scrollToBottomRef,pageInfo:messagesPageInfo,messages:messages,loading:loading,loadingMore:loadingMore,handleSendMessage:sendMessage,handleLoadMore:loadMoreMessages,onEdit:handleEditMessage,onDelete:handleDeleteMessage,onForward:handleForwardMessage,justOpenedChat:justOpenedChat,setJustOpenedChat:setJustOpenedChat,messageListRef:messageListRef,addOptimisticMessage:addOptimisticMessage})})]});};const renderTab=()=>{return/*#__PURE__*/_jsx(Grid,{className:classes.gridContainer,container:true,children:!currentChat.id?/*#__PURE__*/_jsxs(Grid,{item:true,xs:12,children:[/*#__PURE__*/_jsx(\"div\",{style:{display:\"flex\",alignItems:\"center\",justifyContent:\"flex-end\",padding:\"16px 16px 0 16px\",background:\"#fff\",borderBottom:\"1px solid #eee\",position:\"sticky\",top:0,zIndex:100},children:/*#__PURE__*/_jsx(Button,{onClick:()=>setShowDialog(true),color:\"primary\",variant:\"contained\",style:{minWidth:120},children:i18n.t(\"chatIndex.createGroup\")||\"Criar grupo\"})}),/*#__PURE__*/_jsx(\"div\",{style:{background:\"#fff\",position:\"sticky\",top:56,zIndex:99},children:/*#__PURE__*/_jsxs(Tabs,{value:tab,onChange:(e,v)=>setTab(v),indicatorColor:\"primary\",textColor:\"primary\",variant:\"fullWidth\",children:[/*#__PURE__*/_jsx(Tab,{label:i18n.t(\"chatIndex.chats\")||\"Chats\"}),/*#__PURE__*/_jsx(Tab,{label:i18n.t(\"chatIndex.groups\")||\"Grupos\"})]})}),tab===0&&/*#__PURE__*/_jsx(Grid,{className:classes.gridItemTab,md:12,item:true,children:/*#__PURE__*/_jsx(ChatList,{chats:chats.filter(chat=>{const isGroup=chat.isGroup===true||chat.isGroup===\"true\";return!isGroup;}),pageInfo:chatsPageInfo,loading:loading,handleSelectChat:chat=>selectChat(chat),handleDeleteChat:chat=>deleteChat(chat),findChats:findChats})}),tab===1&&/*#__PURE__*/_jsx(Grid,{className:classes.gridItemTab,md:12,item:true,children:/*#__PURE__*/_jsx(ChatList,{chats:chats.filter(chat=>{const isGroup=chat.isGroup===true||chat.isGroup===\"true\";return isGroup;}),pageInfo:chatsPageInfo,loading:loading,handleSelectChat:chat=>selectChat(chat),handleDeleteChat:chat=>deleteChat(chat),handleEditChat:chat=>{setCurrentChat(chat);setDialogType(\"edit\");setShowDialog(true);},findChats:findChats})})]}):/*#__PURE__*/_jsxs(Grid,{className:classes.gridItemTab,md:12,item:true,style:{display:\"flex\",flexDirection:\"column\",height:\"100%\",minHeight:0,padding:0},children:[/*#__PURE__*/_jsx(\"div\",{style:{display:\"flex\",alignItems:\"center\",padding:\"10px\",borderBottom:\"1px solid #eee\",background:\"#fff\",position:\"sticky\",top:0,zIndex:100},children:/*#__PURE__*/_jsx(IconButton,{onClick:()=>setCurrentChat({}),children:/*#__PURE__*/_jsx(ArrowBackIcon,{})})}),/*#__PURE__*/_jsx(\"div\",{style:{flex:1,minHeight:0,display:\"flex\",flexDirection:\"column\"},children:/*#__PURE__*/_jsx(ChatMessages,{chat:currentChat,scrollToBottomRef:scrollToBottomRef,pageInfo:messagesPageInfo,messages:messages,loading:loading,loadingMore:loadingMore,handleSendMessage:sendMessage,handleLoadMore:loadMoreMessages,onEdit:handleEditMessage,onDelete:handleDeleteMessage,onForward:handleForwardMessage// messageListRef={messageListRef}\n// isFirstPage={messagesPage === 2}\n,justOpenedChat:justOpenedChat,setJustOpenedChat:setJustOpenedChat,addOptimisticMessage:addOptimisticMessage})})]})});};useEffect(()=>{if(id&&chats.length){const chat=chats.find(r=>r.uuid===id);// Só chama selectChat se o chat atual for diferente\nif(chat&&(!currentChat||currentChat.id!==chat.id)){selectChat(chat,\"useEffect[id, chats] (mudança de rota ou lista de chats)\");}}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[id,chats]);const addOptimisticMessage=msg=>{setMessages(prev=>[...prev,msg]);};return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(ChatModal,{type:dialogType,open:showDialog,chat:currentChat,handleLoadNewChat:handleLoadNewChat,handleClose:()=>setShowDialog(false),findChats:findChats,setChats:setChats,setChatsPageInfo:setChatsPageInfo,chats:chats,loggedInUserId:user.id}),/*#__PURE__*/_jsx(Paper,{className:classes.mainContainer// style={{\n//   height: \"100%\",\n//   minHeight: 0,\n//   display: \"flex\",\n//   flexDirection: \"column\",\n//   padding: 0,\n// }}\n,children:isMdUp?renderGrid():renderTab()}),/*#__PURE__*/_jsxs(Dialog,{open:editModalOpen,onClose:()=>setEditModalOpen(false),maxWidth:\"md\",fullWidth:true,children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"Editar Mensagem\"}),/*#__PURE__*/_jsx(DialogContent,{children:/*#__PURE__*/_jsx(TextField,{autoFocus:true,margin:\"dense\",label:\"Mensagem\",type:\"text\",fullWidth:true,value:editText,onChange:e=>setEditText(e.target.value),multiline:true,minRows:3,maxRows:10,inputProps:{style:{fontSize:18}}})}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:()=>setEditModalOpen(false),color:\"secondary\",children:i18n.t(\"chatIndex.cancel\")}),/*#__PURE__*/_jsx(Button,{onClick:handleEditSubmit,color:\"primary\",children:i18n.t(\"chatIndex.save\")})]})]}),/*#__PURE__*/_jsxs(Dialog,{open:deleteModalOpen,onClose:()=>setDeleteModalOpen(false),children:[/*#__PURE__*/_jsx(DialogTitle,{children:i18n.t(\"chatIndex.deleteGroup\")}),/*#__PURE__*/_jsx(DialogContent,{children:/*#__PURE__*/_jsx(Typography,{children:i18n.t(\"chatIndex.deleteGroupConfirm\")})}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:()=>setDeleteModalOpen(false),color:\"secondary\",children:i18n.t(\"chatIndex.cancel\")}),/*#__PURE__*/_jsx(Button,{onClick:handleDeleteSubmit,color:\"primary\",children:i18n.t(\"chatIndex.delete\")})]})]}),/*#__PURE__*/_jsxs(Dialog,{open:forwardModalOpen,onClose:()=>setForwardModalOpen(false),children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"Encaminhar Mensagem\"}),/*#__PURE__*/_jsx(DialogContent,{children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,margin:\"dense\",children:[/*#__PURE__*/_jsx(InputLabel,{children:\"Selecione o chat\"}),/*#__PURE__*/_jsx(Select,{value:selectedChatForForward||\"\",onChange:e=>setSelectedChatForForward(e.target.value),children:chats.map(chat=>{var _chat$users$find,_chat$users$find$user;return/*#__PURE__*/_jsx(MenuItem,{value:chat.id,children:chat.isGroup?chat.title:(_chat$users$find=chat.users.find(u=>u.userId!==user.id))===null||_chat$users$find===void 0?void 0:(_chat$users$find$user=_chat$users$find.user)===null||_chat$users$find$user===void 0?void 0:_chat$users$find$user.name},chat.id);})})]})}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:()=>setForwardModalOpen(false),color:\"secondary\",children:\"Cancelar\"}),/*#__PURE__*/_jsx(Button,{onClick:handleForwardSubmit,color:\"primary\",disabled:!selectedChatForForward,children:\"Encaminhar\"})]})]})]});}export default withWidth()(Chat);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}