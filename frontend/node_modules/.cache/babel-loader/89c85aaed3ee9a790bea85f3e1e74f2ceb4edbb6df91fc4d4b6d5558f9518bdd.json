{"ast":null,"code":"import React,{useState,useContext,useEffect}from\"react\";import{useHistory}from\"react-router-dom\";import{toast}from\"react-toastify\";import{Dialog,DialogTitle,DialogContent,DialogActions,Button,TextField,FormControl,InputLabel,Select,MenuItem,Grid,Typography,Radio,RadioGroup,FormControlLabel,FormLabel}from\"@material-ui/core\";import{i18n}from\"../../translate/i18n\";import api from\"../../services/api\";import toastError from\"../../errors/toastError\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const FinalizacaoVendaModal=_ref=>{let{open,onClose,ticket,onFinalizar}=_ref;const history=useHistory();const{user}=useContext(AuthContext);const[loading,setLoading]=useState(false);const[vendaConcluida,setVendaConcluida]=useState(true);const[valorVenda,setValorVenda]=useState(\"\");const[motivoNaoVenda,setMotivoNaoVenda]=useState(\"\");const[motivoFinalizacao,setMotivoFinalizacao]=useState(\"\");const[motivosFinalizacao,setMotivosFinalizacao]=useState([]);const[informarValorVenda,setInformarValorVenda]=useState(false);const[loadingConfig,setLoadingConfig]=useState(true);const[showOptionsModal,setShowOptionsModal]=useState(false);const[ticketDataToFinalize,setTicketDataToFinalize]=useState(null);const handleClose=()=>{onClose();setVendaConcluida(true);setValorVenda(\"\");setMotivoNaoVenda(\"\");setMotivoFinalizacao(\"\");};useEffect(()=>{if(open){setLoadingConfig(true);Promise.all([fetchMotivosFinalizacao(),fetchCompanySettings()]).then(()=>setLoadingConfig(false));}},[open]);const fetchMotivosFinalizacao=async()=>{try{const{data}=await api.get(\"/ticketFinalizationReasons\");setMotivosFinalizacao(data);}catch(err){console.error(\"Erro ao buscar motivos de finalização:\",err);}};const fetchCompanySettings=async()=>{try{const{data}=await api.get(\"/companySettings\");setInformarValorVenda(data.informarValorVenda||false);}catch(err){console.error(\"Erro ao buscar configurações da empresa:\",err);}};const handleSubmit=async()=>{if(informarValorVenda){// Check ativado: lógica antiga\nif(vendaConcluida){if(!valorVenda){toast.error(\"Por favor, informe o valor da venda.\");return;}}else{if(!motivoNaoVenda){toast.error(\"Por favor, selecione o motivo da não venda.\");return;}}}else{// Check desativado: só motivo de finalização\nif(!motivoFinalizacao){toast.error(\"Por favor, selecione o motivo da finalização.\");return;}}// Em vez de finalizar aqui, apenas passa os dados para o pai\nconst ticketData={status:\"closed\",userId:(user===null||user===void 0?void 0:user.id)||null// sendFarewellMessage e finalizacaoMessage serão definidos no modal seguinte\n};if(informarValorVenda){ticketData.finalizadoComVenda=vendaConcluida;if(vendaConcluida){ticketData.valorVenda=parseFloat(valorVenda);ticketData.motivoNaoVenda=null;ticketData.motivoFinalizacao=null;}else{ticketData.valorVenda=null;ticketData.motivoNaoVenda=motivoNaoVenda;ticketData.motivoFinalizacao=null;}}else{ticketData.finalizadoComVenda=null;ticketData.valorVenda=null;ticketData.motivoNaoVenda=null;ticketData.motivoFinalizacao=motivoFinalizacao;}// Chama o callback passando os dados\nif(onFinalizar)onFinalizar(ticketData);handleClose();};return/*#__PURE__*/_jsxs(Dialog,{open:open,onClose:handleClose,maxWidth:\"sm\",fullWidth:true,children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"Finaliza\\xE7\\xE3o de Atendimento - Valor de Venda\"}),loadingConfig?/*#__PURE__*/_jsx(DialogContent,{children:/*#__PURE__*/_jsx(Typography,{children:\"Carregando configura\\xE7\\xF5es...\"})}):/*#__PURE__*/_jsx(DialogContent,{children:/*#__PURE__*/_jsx(Grid,{container:true,spacing:2,children:informarValorVenda?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,children:/*#__PURE__*/_jsxs(FormControl,{component:\"fieldset\",children:[/*#__PURE__*/_jsx(FormLabel,{component:\"legend\",children:\"A venda foi conclu\\xEDda?\"}),/*#__PURE__*/_jsxs(RadioGroup,{value:vendaConcluida,onChange:e=>setVendaConcluida(e.target.value===\"true\"),children:[/*#__PURE__*/_jsx(FormControlLabel,{value:true,control:/*#__PURE__*/_jsx(Radio,{}),label:\"Sim, venda conclu\\xEDda\"}),/*#__PURE__*/_jsx(FormControlLabel,{value:false,control:/*#__PURE__*/_jsx(Radio,{}),label:\"N\\xE3o, venda n\\xE3o conclu\\xEDda\"})]})]})}),vendaConcluida?/*#__PURE__*/_jsx(Grid,{item:true,xs:12,children:/*#__PURE__*/_jsx(TextField,{label:\"Valor da Venda (R$)\",type:\"number\",value:valorVenda,onChange:e=>setValorVenda(e.target.value),fullWidth:true,variant:\"outlined\",margin:\"dense\",inputProps:{step:\"0.01\",min:\"0\"},placeholder:\"0,00\"})}):/*#__PURE__*/_jsx(Grid,{item:true,xs:12,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,variant:\"outlined\",margin:\"dense\",required:true,children:[/*#__PURE__*/_jsx(InputLabel,{children:\"Motivo da N\\xE3o Venda *\"}),/*#__PURE__*/_jsxs(Select,{value:motivoNaoVenda,onChange:e=>setMotivoNaoVenda(e.target.value),label:\"Motivo da N\\xE3o Venda *\",children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:/*#__PURE__*/_jsx(\"em\",{children:\"Selecione um motivo\"})}),motivosFinalizacao.map(motivo=>/*#__PURE__*/_jsx(MenuItem,{value:motivo.name,children:motivo.name},motivo.id))]})]})})]}):/*#__PURE__*/_jsx(Grid,{item:true,xs:12,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,variant:\"outlined\",margin:\"dense\",required:true,children:[/*#__PURE__*/_jsx(InputLabel,{children:\"Motivo da Finaliza\\xE7\\xE3o *\"}),/*#__PURE__*/_jsxs(Select,{value:motivoFinalizacao,onChange:e=>setMotivoFinalizacao(e.target.value),label:\"Motivo da Finaliza\\xE7\\xE3o *\",children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:/*#__PURE__*/_jsx(\"em\",{children:\"Selecione um motivo\"})}),motivosFinalizacao.map(motivo=>/*#__PURE__*/_jsx(MenuItem,{value:motivo.name,children:motivo.name},motivo.id))]})]})})})}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:handleClose,color:\"secondary\",disabled:loading,children:\"Cancelar\"}),/*#__PURE__*/_jsx(Button,{onClick:handleSubmit,color:\"primary\",variant:\"contained\",disabled:loading||loadingConfig,children:loading?\"Finalizando...\":\"Finalizar Atendimento\"})]})]});};export default FinalizacaoVendaModal;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}