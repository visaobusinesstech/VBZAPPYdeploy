{"ast":null,"code":"import _objectSpread from\"/home/deploy/atendechatop/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";/* eslint-disable no-unused-vars */import React,{useState,useEffect,useReducer,useContext}from\"react\";import{toast}from\"react-toastify\";import{useHistory}from\"react-router-dom\";import{makeStyles}from\"@material-ui/core/styles\";import Paper from\"@material-ui/core/Paper\";import Button from\"@material-ui/core/Button\";import IconButton from\"@material-ui/core/IconButton\";import Typography from\"@material-ui/core/Typography\";import DeleteOutlineIcon from\"@material-ui/icons/DeleteOutline\";import EditIcon from\"@material-ui/icons/Edit\";import MainContainer from\"../../components/MainContainer\";import MainHeader from\"../../components/MainHeader\";import Title from\"../../components/Title\";import api from\"../../services/api\";import{i18n}from\"../../translate/i18n\";import ConfirmationModal from\"../../components/ConfirmationModal\";import toastError from\"../../errors/toastError\";import{isArray}from\"lodash\";import{AuthContext}from\"../../context/Auth/AuthContext\";import CampaignModalPhrase from\"../../components/CampaignModalPhrase\";import{AddCircle,TextFields,Link as LinkIcon}from\"@mui/icons-material\";import{CircularProgress,Grid,Stack,Chip,Box,Tooltip}from\"@mui/material\";import{Can}from\"../../components/Can\";import{colorBackgroundTable,colorLineTable,colorLineTableHover,colorTopTable}from\"../../styles/styles\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const reducer=(state,action)=>{if(action.type===\"LOAD_CAMPAIGNS\"){const campaigns=action.payload;const newCampaigns=[];if(isArray(campaigns)){campaigns.forEach(campaign=>{const campaignIndex=state.findIndex(u=>u.id===campaign.id);if(campaignIndex!==-1){state[campaignIndex]=campaign;}else{newCampaigns.push(campaign);}});}return[...state,...newCampaigns];}if(action.type===\"UPDATE_CAMPAIGNS\"){const campaign=action.payload;const campaignIndex=state.findIndex(u=>u.id===campaign.id);if(campaignIndex!==-1){state[campaignIndex]=campaign;return[...state];}else{return[campaign,...state];}}if(action.type===\"DELETE_CAMPAIGN\"){const campaignId=action.payload;const campaignIndex=state.findIndex(u=>u.id===campaignId);if(campaignIndex!==-1){state.splice(campaignIndex,1);}return[...state];}if(action.type===\"RESET\"){return[];}};const useStyles=makeStyles(theme=>({mainPaper:_objectSpread({flex:1,backgroundColor:colorBackgroundTable(),borderRadius:12,padding:theme.spacing(1),overflowY:\"scroll\"},theme.scrollbarStyles),whatsappChip:{margin:\"2px\",fontSize:\"0.75rem\",height:\"20px\"},connectionContainer:{display:\"flex\",flexWrap:\"wrap\",gap:\"4px\",alignItems:\"center\"}}));const CampaignsPhrase=()=>{const classes=useStyles();const history=useHistory();const{user}=useContext(AuthContext);const[loading,setLoading]=useState(true);const[confirmModalOpen,setConfirmModalOpen]=useState(false);const[deletingContact,setDeletingContact]=useState(null);// Estados das campanhas\nconst[campaignflows,setCampaignFlows]=useState([]);const[ModalOpenPhrase,setModalOpenPhrase]=useState(false);const[campaignflowSelected,setCampaignFlowSelected]=useState();// Estado para lista de WhatsApps (para exibir nomes)\nconst[whatsApps,setWhatsApps]=useState([]);const handleDeleteCampaign=async campaignId=>{try{await api.delete(\"/flowcampaign/\".concat(campaignId));toast.success(\"Campanha deletada com sucesso\");getCampaigns();}catch(err){toastError(err);}setConfirmModalOpen(false);setDeletingContact(null);};// Buscar lista de WhatsApps para mostrar nomes\nconst getWhatsApps=async()=>{try{const response=await api.get(\"/whatsapp\");setWhatsApps(response.data||[]);}catch(error){console.error('Erro ao buscar WhatsApps:',error);}};const getCampaigns=async()=>{try{setLoading(true);const response=await api.get(\"/flowcampaign\");console.log('Resposta completa da API:',response.data);// Verificar diferentes estruturas de resposta possíveis\nlet flowData=[];if(response.data){if(Array.isArray(response.data.flow)){flowData=response.data.flow;}else if(response.data.data&&Array.isArray(response.data.data.flow)){flowData=response.data.data.flow;}else if(Array.isArray(response.data.data)){flowData=response.data.data;}else if(Array.isArray(response.data)){flowData=response.data;}else{const dataKeys=Object.keys(response.data);for(const key of dataKeys){if(Array.isArray(response.data[key])){flowData=response.data[key];break;}}}}console.log('Dados das campanhas extraídos:',flowData);setCampaignFlows(flowData);}catch(error){console.error('Erro ao buscar campanhas:',error);toastError(error);setCampaignFlows([]);}finally{setLoading(false);}};const onSaveModal=()=>{getCampaigns();};// NOVA FUNÇÃO: Renderizar chips das conexões\nconst renderWhatsAppConnections=whatsappIds=>{if(!whatsappIds||!Array.isArray(whatsappIds)||whatsappIds.length===0){return/*#__PURE__*/_jsx(Typography,{variant:\"body2\",color:\"textSecondary\",children:\"Nenhuma conex\\xE3o\"});}// Se há muitas conexões, mostrar resumo\nif(whatsappIds.length>3){const firstTwo=whatsappIds.slice(0,2);const remaining=whatsappIds.length-2;return/*#__PURE__*/_jsxs(Box,{className:classes.connectionContainer,children:[firstTwo.map(whatsappId=>{const whatsapp=whatsApps.find(w=>w.id===whatsappId);return/*#__PURE__*/_jsx(Tooltip,{title:whatsapp?\"\".concat(whatsapp.name,\" (\").concat(whatsapp.status,\")\"):\"ID: \".concat(whatsappId),children:/*#__PURE__*/_jsx(Chip,{label:whatsapp?whatsapp.name:\"ID: \".concat(whatsappId),className:classes.whatsappChip,size:\"small\",color:(whatsapp===null||whatsapp===void 0?void 0:whatsapp.status)===\"CONNECTED\"?\"success\":\"default\",variant:\"outlined\"})},whatsappId);}),/*#__PURE__*/_jsx(Tooltip,{title:\"Mais \".concat(remaining,\" conex\\xE3o(\\xF5es)\"),children:/*#__PURE__*/_jsx(Chip,{label:\"+\".concat(remaining),className:classes.whatsappChip,size:\"small\",color:\"primary\",variant:\"outlined\"})})]});}// Mostrar todas as conexões se forem poucas\nreturn/*#__PURE__*/_jsx(Box,{className:classes.connectionContainer,children:whatsappIds.map(whatsappId=>{const whatsapp=whatsApps.find(w=>w.id===whatsappId);return/*#__PURE__*/_jsx(Tooltip,{title:whatsapp?\"\".concat(whatsapp.name,\" (\").concat(whatsapp.status,\")\"):\"ID: \".concat(whatsappId),children:/*#__PURE__*/_jsx(Chip,{label:whatsapp?whatsapp.name:\"ID: \".concat(whatsappId),className:classes.whatsappChip,size:\"small\",color:(whatsapp===null||whatsapp===void 0?void 0:whatsapp.status)===\"CONNECTED\"?\"success\":\"default\",variant:\"outlined\"})},whatsappId);})});};useEffect(()=>{getCampaigns();getWhatsApps();// Carregar lista de WhatsApps\n},[]);return/*#__PURE__*/_jsxs(MainContainer,{children:[/*#__PURE__*/_jsx(ConfirmationModal,{title:deletingContact&&\"\".concat(i18n.t(\"campaigns.confirmationModal.deleteTitle\"),\" \").concat(deletingContact.name,\"?\"),open:confirmModalOpen,onClose:()=>setConfirmModalOpen(false),onConfirm:()=>handleDeleteCampaign(deletingContact.id),children:i18n.t(\"campaigns.confirmationModal.deleteMessage\")}),/*#__PURE__*/_jsx(CampaignModalPhrase,{open:ModalOpenPhrase,onClose:()=>setModalOpenPhrase(false),FlowCampaignId:campaignflowSelected,onSave:onSaveModal}),/*#__PURE__*/_jsx(MainHeader,{children:/*#__PURE__*/_jsxs(Grid,{style:{width:\"99.6%\"},container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:12,sm:8,item:true,children:/*#__PURE__*/_jsx(Title,{children:\"Campanhas de Fluxo\"})}),/*#__PURE__*/_jsx(Grid,{xs:12,sm:4,item:true,children:/*#__PURE__*/_jsxs(Grid,{spacing:2,container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:6,sm:6,item:true}),/*#__PURE__*/_jsx(Grid,{xs:6,sm:6,item:true,children:/*#__PURE__*/_jsx(Button,{fullWidth:true,variant:\"contained\",onClick:()=>{setCampaignFlowSelected(undefined);setModalOpenPhrase(true);},color:\"primary\",style:{textTransform:\"none\"},children:/*#__PURE__*/_jsxs(Stack,{direction:\"row\",gap:1,children:[/*#__PURE__*/_jsx(AddCircle,{}),\"Nova Campanha\"]})})})]})})]})}),/*#__PURE__*/_jsx(Paper,{className:classes.mainPaper,variant:\"outlined\",children:/*#__PURE__*/_jsxs(Stack,{children:[/*#__PURE__*/_jsxs(Grid,{container:true,style:{padding:\"8px\"},children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:3,style:{color:colorTopTable()},children:\"Nome\"}),/*#__PURE__*/_jsx(Grid,{item:true,xs:3,style:{color:colorTopTable()},align:\"center\",children:\"Conex\\xF5es\"}),/*#__PURE__*/_jsx(Grid,{item:true,xs:3,style:{color:colorTopTable()},align:\"center\",children:\"Status\"}),/*#__PURE__*/_jsx(Grid,{item:true,xs:3,align:\"end\",style:{color:colorTopTable()},children:i18n.t(\"contacts.table.actions\")})]}),loading?/*#__PURE__*/_jsx(Stack,{justifyContent:\"center\",alignItems:\"center\",minHeight:\"50vh\",children:/*#__PURE__*/_jsx(CircularProgress,{})}):/*#__PURE__*/_jsx(_Fragment,{children:campaignflows&&Array.isArray(campaignflows)&&campaignflows.length>0?campaignflows.map(flow=>/*#__PURE__*/_jsxs(Grid,{container:true,sx:{padding:\"8px\",backgroundColor:colorLineTable(),borderRadius:4,marginTop:0.5,\"&:hover\":{backgroundColor:colorLineTableHover()}},children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:3,children:/*#__PURE__*/_jsx(Stack,{justifyContent:\"center\",height:\"100%\",style:{color:\"#ededed\"},children:/*#__PURE__*/_jsxs(Stack,{direction:\"row\",alignItems:\"center\",children:[/*#__PURE__*/_jsx(TextFields,{}),/*#__PURE__*/_jsxs(Stack,{justifyContent:\"center\",marginLeft:1,children:[/*#__PURE__*/_jsx(Typography,{variant:\"body2\",style:{fontWeight:500},children:flow.name||'Nome não definido'}),flow.phrase&&Array.isArray(flow.phrase)&&/*#__PURE__*/_jsxs(Typography,{variant:\"caption\",style:{color:\"#bbb\"},children:[flow.phrase.length,\" frase(s) configurada(s)\"]})]})]})})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:3,align:\"center\",children:/*#__PURE__*/_jsx(Stack,{justifyContent:\"center\",height:\"100%\",children:renderWhatsAppConnections(flow.whatsappIds)})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:3,align:\"center\",style:{color:\"#ededed\"},children:/*#__PURE__*/_jsx(Stack,{justifyContent:\"center\",height:\"100%\",children:/*#__PURE__*/_jsx(Chip,{label:flow.status?\"Ativo\":\"Desativado\",size:\"small\",color:flow.status?\"success\":\"default\",variant:flow.status?\"filled\":\"outlined\"})})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:3,align:\"end\",children:/*#__PURE__*/_jsxs(Stack,{direction:\"row\",justifyContent:\"flex-end\",alignItems:\"center\",children:[/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:()=>{setCampaignFlowSelected(flow.id);setModalOpenPhrase(true);},title:\"Editar campanha\",children:/*#__PURE__*/_jsx(EditIcon,{style:{color:\"#ededed\"}})}),/*#__PURE__*/_jsx(Can,{role:user.profile,perform:\"contacts-page:deleteContact\",yes:()=>/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:e=>{setConfirmModalOpen(true);setDeletingContact(flow);},title:\"Excluir campanha\",children:/*#__PURE__*/_jsx(DeleteOutlineIcon,{style:{color:\"#ededed\"}})})})]})})]},flow.id)):/*#__PURE__*/_jsxs(Stack,{justifyContent:\"center\",alignItems:\"center\",minHeight:\"20vh\",style:{color:\"#ededed\"},children:[/*#__PURE__*/_jsx(Typography,{variant:\"body1\",children:\"Nenhuma campanha encontrada\"}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",style:{marginTop:\"8px\",color:\"#bbb\"},children:\"Clique em \\\"Nova Campanha\\\" para criar sua primeira campanha de fluxo\"})]})})]})})]});};export default CampaignsPhrase;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}