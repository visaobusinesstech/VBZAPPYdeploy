{"ast":null,"code":"import _objectSpread from\"/home/deploy/atendechatop/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState}from'react';import{Modal,Box,TextField,Typography,IconButton,List,ListItem,ListItemText,Button}from'@material-ui/core';import SearchIcon from'@material-ui/icons/Search';import{makeStyles}from'@material-ui/core/styles';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const useStyles=makeStyles(theme=>({modal:{display:'flex',alignItems:'center',justifyContent:'center'},modalContent:{width:'80%',maxHeight:'80%',backgroundColor:theme.palette.background.paper,padding:theme.spacing(2),borderRadius:theme.shape.borderRadius,overflowY:'auto'},searchContainer:{display:'flex',alignItems:'center',marginBottom:theme.spacing(2)},searchInput:{marginLeft:theme.spacing(1),flex:1},templateItem:{backgroundColor:theme.palette.optionsBackground,color:theme.palette.primary,padding:theme.spacing(2),borderRadius:theme.shape.borderRadius,marginBottom:theme.spacing(2)},templateInfo:{display:'flex',justifyContent:'space-between',alignItems:'center'},category:{marginTop:theme.spacing(1)}}));const TemplateModal=_ref=>{let{open,handleClose,templates,onSelectTemplate}=_ref;const classes=useStyles();const[search,setSearch]=useState('');const[selectedTemplate,setSelectedTemplate]=useState(null);const[variables,setVariables]=useState([]);const[variableValues,setVariableValues]=useState({});const[renderedContent,setRenderedContent]=useState('');const handleSearchChange=event=>{setSearch(event.target.value);};const extractVariablesByComponent=components=>{const regex=/{{(\\d+)}}/g;let variables={header:[],body:[],footer:[],buttons:[]};components.forEach(component=>{var _component$type;let match;const type=(_component$type=component.type)===null||_component$type===void 0?void 0:_component$type.toLowerCase();const text=component.text||'';if(type==='header'&&['IMAGE','VIDEO'].includes(component===null||component===void 0?void 0:component.format)){variables[type].push({type:\"\".concat(component===null||component===void 0?void 0:component.format.toLowerCase()),prompt:(component===null||component===void 0?void 0:component.format.toLowerCase())==='image'?'Insira a URL da imagem':'Insira a URL do vídeo'});}// Para os botões, verifique a URL para variáveis\nif(type==='buttons'){const buttons=JSON.parse(component.buttons);buttons.forEach((button,index)=>{if(button.example){console.log(\"button\",button,index);variables[type].push({type:button.type,prompt:button.example,index:index});}else if(variables[type]){while((match=regex.exec(text))!==null){variables[type].push(match[0]);}}});}else if(variables[type]){while((match=regex.exec(text))!==null){variables[type].push({type:'text',prompt:match[0]});}}else{console.warn(\"Tipo de componente desconhecido: \".concat(type));}});return variables;};const handleSelectTemplate=template=>{const components=(template===null||template===void 0?void 0:template.components)||[];const extractedVariables=extractVariablesByComponent(components);setSelectedTemplate(template);setVariables(extractedVariables);setRenderedContent(components.map(component=>component===null||component===void 0?void 0:component.text).join(\"\\n\"));};// const generateBodyToSave = (content, variables) => {\n//     let bodyToSave = content;\n//     console.log(\"variables\", variables)\n//     console.log(\"bodyToSave\", bodyToSave)\n//     Object.keys(variables).forEach((componentType) => {\n//         console.log(\"componentType\", componentType)\n//         const componentVariables = variables[componentType];\n//         console.log(\"componentVariables\", componentVariables, typeof componentVariables)\n//         // Verificar se componentVariables é um array\n//         if (Array.isArray(componentVariables)) {\n//             componentVariables.forEach((variable, index) => {\n//                 const placeholder = `{{${index + 1}}}`;\n//                 const value = variable?.value || '';\n//                 bodyToSave = bodyToSave.replace(placeholder, value);\n//             });\n//         } else if (typeof componentVariables === 'object') {\n//             Object.keys(componentVariables).forEach((key, index) => {\n//                 const placeholder = `{{${index + 1}}}`;\n//                 const value = componentVariables[key]?.value || '';\n//                 bodyToSave = bodyToSave.replace(placeholder, value);\n//             });\n//         } else {\n//             console.error(`Expected array or object for componentType: ${componentType}, but got`, componentVariables);\n//         }\n//     });\n//     console.log(\"bodyToSave\", bodyToSave)\n//     return bodyToSave;\n// };\nconst generateBodyToSave=(content,variables)=>{let bodyToSave=content;Object.keys(variables).forEach(componentType=>{const componentVariables=variables[componentType];if(Array.isArray(componentVariables)){console.log(\"componentVariables ARRAY\",componentVariables);// Se for um array, iteramos sobre ele substituindo as variáveis\ncomponentVariables.forEach((variable,index)=>{const placeholder=\"{{\".concat(index+1,\"}}\");const value=(variable===null||variable===void 0?void 0:variable.value)||'';bodyToSave=bodyToSave.replace(placeholder,value);});}else if(typeof componentVariables==='object'){console.log(\"componentVariables OBJECT\",componentVariables);// Se for um objeto (caso do header com uma imagem ou outro tipo de conteúdo)\nif(componentType==='header'){console.log(\"componentVariables\",componentVariables);// Substituir um placeholder específico no header por uma URL de imagem\nObject.keys(componentVariables).forEach((key,index)=>{var _componentVariables$k;const value=((_componentVariables$k=componentVariables[key])===null||_componentVariables$k===void 0?void 0:_componentVariables$k.value)||'';console.log(\"value\",value,value.startsWith(\"http\"));if(value.startsWith(\"http\")){bodyToSave=\"\".concat(value,\" \\n \").concat(bodyToSave);console.log(\"bodyToSave\",bodyToSave);}else{const placeholder=\"{{\".concat(index+1,\"}}\");bodyToSave=bodyToSave.replace(placeholder,value);}});}else{// Para texto ou outros tipos de componentes, substituímos as variáveis como antes\nObject.keys(componentVariables).forEach((key,index)=>{var _componentVariables$k2;const placeholder=\"{{\".concat(index+1,\"}}\");const value=((_componentVariables$k2=componentVariables[key])===null||_componentVariables$k2===void 0?void 0:_componentVariables$k2.value)||'';bodyToSave=bodyToSave.replace(placeholder,value);});}}else{console.error(\"Expected array or object for componentType: \".concat(componentType,\", but got\"),componentVariables);}});console.log(\"bodyToSave\",bodyToSave);return bodyToSave;};const handleSendTemplate=()=>{const bodyToSave=generateBodyToSave(renderedContent,variableValues);const templateWithVariables=_objectSpread(_objectSpread({},selectedTemplate),{},{variables:variableValues,bodyToSave});onSelectTemplate(templateWithVariables);};const handleVariableChange=(componentType,index,value,buttonIndex)=>{// Atualiza o estado das variáveis por tipo de componente\nconst newComponentValues=_objectSpread(_objectSpread({},variableValues[componentType]),{},{[index]:{value,buttonIndex}});const newValues=_objectSpread(_objectSpread({},variableValues),{},{[componentType]:newComponentValues});setVariableValues(newValues);};const filteredTemplates=templates.filter(template=>{var _template$shortcode;return template===null||template===void 0?void 0:(_template$shortcode=template.shortcode)===null||_template$shortcode===void 0?void 0:_template$shortcode.toLowerCase().includes(search===null||search===void 0?void 0:search.toLowerCase());});return/*#__PURE__*/_jsx(Modal,{open:open,onClose:handleClose,className:classes.modal,maxWidth:\"md\",\"aria-labelledby\":\"template-modal-title\",children:/*#__PURE__*/_jsxs(Box,{className:classes.modalContent,children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",id:\"template-modal-title\",children:\"Templates do WhatsApp\"}),!selectedTemplate&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"div\",{className:classes.searchContainer,children:[/*#__PURE__*/_jsx(SearchIcon,{}),/*#__PURE__*/_jsx(TextField,{variant:\"outlined\",placeholder:\"Pesquisar Templates\",value:search,onChange:handleSearchChange,className:classes.searchInput})]}),/*#__PURE__*/_jsx(List,{children:filteredTemplates.map((template,index)=>{var _template$components;return/*#__PURE__*/_jsx(ListItem,{className:classes.templateItem,onClick:()=>handleSelectTemplate(template),children:/*#__PURE__*/_jsx(ListItemText,{primary:/*#__PURE__*/_jsxs(\"div\",{className:classes.templateInfo,children:[/*#__PURE__*/_jsx(Typography,{variant:\"body1\",children:template.shortcode}),/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",children:[\"Idioma: \",template.language]})]}),secondary:/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",component:\"div\",children:[\"Conte\\xFAdo do Template: \",template===null||template===void 0?void 0:(_template$components=template.components)===null||_template$components===void 0?void 0:_template$components.map(component=>component===null||component===void 0?void 0:component.text).join(\"\\n\")]}),/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",className:classes.category,children:[\"Categoria: \",template.category]})]})})},index);})})]}),selectedTemplate&&/*#__PURE__*/_jsxs(Box,{mt:2,children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",children:\"Detalhes do Template Selecionado\"}),/*#__PURE__*/_jsxs(Typography,{variant:\"body1\",children:[\"Nome: \",selectedTemplate.name]}),/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",children:[\"Conte\\xFAdo: \",renderedContent]}),/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",children:[\"Idioma: \",selectedTemplate.language]}),/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",children:[\"Categoria: \",selectedTemplate.category]}),Object.keys(variables).map((componentType,index)=>/*#__PURE__*/_jsx(\"div\",{children:variables[componentType].length>0&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",children:componentType.toUpperCase()}),variables[componentType].map((variable,index)=>{var _variableValues$compo,_variableValues$compo2;return/*#__PURE__*/_jsx(TextField,{label:\"\".concat(variable===null||variable===void 0?void 0:variable.prompt),value:((_variableValues$compo=variableValues[componentType])===null||_variableValues$compo===void 0?void 0:(_variableValues$compo2=_variableValues$compo[index])===null||_variableValues$compo2===void 0?void 0:_variableValues$compo2.value)||'',onChange:e=>handleVariableChange(componentType,index,e.target.value,(variable===null||variable===void 0?void 0:variable.index)||0),fullWidth:true,margin:\"normal\"},\"\".concat(componentType,\"-\").concat(index));})]})},\"\".concat(componentType,\"-\").concat(index))),/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",onClick:handleSendTemplate,fullWidth:true,style:{marginTop:16},children:\"Enviar\"}),/*#__PURE__*/_jsx(Button,{variant:\"outlined\",onClick:()=>{setSelectedTemplate(null);setVariableValues({});setRenderedContent('');},fullWidth:true,style:{marginTop:8},children:\"Voltar\"})]})]})});};export default TemplateModal;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}