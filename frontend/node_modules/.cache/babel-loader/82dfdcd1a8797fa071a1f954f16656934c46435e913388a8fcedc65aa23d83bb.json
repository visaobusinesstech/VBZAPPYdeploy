{"ast":null,"code":"import _objectSpread from\"/home/deploy/atendechatop/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useContext}from'react';import{makeStyles}from'@material-ui/core/styles';import api from'../../services/api';import{AuthContext}from'../../context/Auth/AuthContext';import{toast}from'react-toastify';import{i18n}from'../../translate/i18n';import{useHistory}from'react-router-dom';import{setKanbanLaneOrder,getKanbanLaneOrder}from'../../services/companyKanbanService';import{Button,TextField,Paper,FormControl,InputLabel,Select}from'@material-ui/core';import{format}from'date-fns';import{Can}from'../../components/Can';import MainContainer from'../../components/MainContainer';import MainHeader from'../../components/MainHeader';import MainHeaderButtonsWrapper from'../../components/MainHeaderButtonsWrapper';import Title from'../../components/Title';import KanbanBoard from'./KanbanBoard';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const useStyles=makeStyles(theme=>({mainPaper:_objectSpread(_objectSpread({flex:1,display:'flex',padding:theme.spacing(1),overflowX:'auto'},theme.scrollbarStyles),{},{borderRadius:'10px'}),button:{borderRadius:'10px'},dateInput:{'& .MuiOutlinedInput-root':{borderRadius:'10px'},marginRight:theme.spacing(1)},sortSelect:{minWidth:150,marginRight:theme.spacing(1),'& .MuiOutlinedInput-root':{borderRadius:'10px'}}}));const Kanban=()=>{const classes=useStyles();const history=useHistory();const{user,socket}=useContext(AuthContext);const[tags,setTags]=useState([]);const[tickets,setTickets]=useState([]);const[lanes,setLanes]=useState([]);const[startDate,setStartDate]=useState(format(new Date(),'yyyy-MM-dd'));const[endDate,setEndDate]=useState(format(new Date(),'yyyy-MM-dd'));const queueIds=user.queues.map(queue=>queue.UserQueue.queueId);const[sortOrder,setSortOrder]=useState(()=>{return localStorage.getItem('sortOrder')||'ticketNumber';});const[laneOrder,setLaneOrder]=useState(null);const[loadingLaneOrder,setLoadingLaneOrder]=useState(true);useEffect(()=>{localStorage.setItem('sortOrder',sortOrder);},[sortOrder]);// Carregar ordem das lanes do banco de dados\nuseEffect(()=>{const loadLaneOrder=async()=>{try{const savedOrder=await getKanbanLaneOrder();setLaneOrder(savedOrder);}catch(error){console.error('Erro ao carregar ordem das lanes:',error);}finally{setLoadingLaneOrder(false);}};if(user&&user.id){loadLaneOrder();}},[user]);useEffect(()=>{fetchTags();// eslint-disable-next-line react-hooks/exhaustive-deps\n},[]);const fetchTags=async()=>{try{const response=await api.get('/tag/kanban/');const fetchedTags=response.data.lista||[];setTags(fetchedTags);fetchTickets(fetchedTags);}catch(error){console.log(error);}};const fetchTickets=async function(){let fetchedTags=arguments.length>0&&arguments[0]!==undefined?arguments[0]:tags;try{const{data}=await api.get('/ticket/kanban',{params:{queueIds:JSON.stringify(queueIds),startDate:startDate,endDate:endDate}});setTickets(data.tickets);organizeLanes(fetchedTags,data.tickets);}catch(err){console.log(err);setTickets([]);}};useEffect(()=>{const companyId=user.companyId;const onAppMessage=data=>{if(['create','update','delete'].includes(data.action)){fetchTickets();}};socket.on(\"company-\".concat(companyId,\"-ticket\"),onAppMessage);socket.on(\"company-\".concat(companyId,\"-appMessage\"),onAppMessage);return()=>{socket.off(\"company-\".concat(companyId,\"-ticket\"),onAppMessage);socket.off(\"company-\".concat(companyId,\"-appMessage\"),onAppMessage);};// eslint-disable-next-line react-hooks/exhaustive-deps\n},[socket,user.companyId]);const handleSearchClick=()=>{fetchTickets();};const handleStartDateChange=event=>{setStartDate(event.target.value);};const handleEndDateChange=event=>{setEndDate(event.target.value);};const updateTicket=updatedTicket=>{setTickets(prevTickets=>prevTickets.map(ticket=>ticket.id===updatedTicket.id?updatedTicket:ticket));};const getOpportunityValue=ticket=>{const customFields=ticket.contact.extraInfo||[];const valueField=customFields.find(field=>field.name==='valor');const opportunityValue=valueField?parseFloat(valueField.value):0;return opportunityValue;};const organizeLanes=function(){let fetchedTags=arguments.length>0&&arguments[0]!==undefined?arguments[0]:tags;let fetchedTickets=arguments.length>1&&arguments[1]!==undefined?arguments[1]:tickets;const sortedTickets=[...fetchedTickets];if(sortOrder==='ticketNumber'){sortedTickets.sort((a,b)=>a.id-b.id);}else if(sortOrder==='lastMessageTime'){sortedTickets.sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));}else if(sortOrder==='valorDesc'){sortedTickets.sort((a,b)=>{const valorA=getOpportunityValue(a);const valorB=getOpportunityValue(b);return valorB-valorA;});}const defaultTickets=sortedTickets.filter(ticket=>ticket.tags.length===0);const lanesData=[{id:'lane0',title:i18n.t('tagsKanban.laneDefault'),tickets:defaultTickets,color:'#757575'},...fetchedTags.map(tag=>{const taggedTickets=sortedTickets.filter(ticket=>ticket.tags.some(t=>t.id===tag.id));return{id:tag.id.toString(),title:tag.name,tickets:taggedTickets,color:tag.color||'#757575'};})];// Aplicar ordem personalizada se existir\nif(laneOrder&&laneOrder.length>0){const orderedLanes=[];const laneMap=new Map(lanesData.map(lane=>[lane.id,lane]));// Adicionar lanes na ordem salva\nlaneOrder.forEach(laneId=>{if(laneMap.has(laneId)){orderedLanes.push(laneMap.get(laneId));laneMap.delete(laneId);}});// Adicionar lanes restantes (novas lanes que não estavam na ordem salva)\nlaneMap.forEach(lane=>orderedLanes.push(lane));setLanes(orderedLanes);}else{setLanes(lanesData);}};useEffect(()=>{if(!loadingLaneOrder){organizeLanes();}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[tags,tickets,sortOrder,laneOrder,loadingLaneOrder]);const handleCardMove=async(ticketId,targetLaneId)=>{ticketId=parseInt(ticketId,10);try{await api.delete(\"/ticket-tags/\".concat(ticketId));if(targetLaneId!=='lane0'){await api.put(\"/ticket-tags/\".concat(ticketId,\"/\").concat(targetLaneId));toast.success('Ticket Tag atualizado com sucesso!');}else{toast.success('Ticket Tag removido!');}fetchTickets();}catch(err){console.log(err);}};const handleAddColumnClick=()=>{history.push('/tagsKanban');};const handleSortOrderChange=event=>{setSortOrder(event.target.value);};const handleLaneReorder=async(sourceIndex,destinationIndex)=>{// Verificar se o usuário é admin\nif(user.profile!=='admin'){toast.error('Apenas administradores podem reordenar as lanes do Kanban');return;}const newLanes=Array.from(lanes);const[reorderedLane]=newLanes.splice(sourceIndex,1);newLanes.splice(destinationIndex,0,reorderedLane);setLanes(newLanes);// Salvar nova ordem no banco de dados\nconst newLaneOrder=newLanes.map(lane=>lane.id);setLaneOrder(newLaneOrder);try{await setKanbanLaneOrder(newLaneOrder);toast.success('Ordem das lanes atualizada com sucesso');}catch(error){console.error('Erro ao salvar ordem das lanes:',error);toast.error('Erro ao salvar ordem das lanes');}};return/*#__PURE__*/_jsxs(MainContainer,{children:[/*#__PURE__*/_jsxs(MainHeader,{children:[/*#__PURE__*/_jsx(Title,{children:i18n.t('Kanban')}),/*#__PURE__*/_jsxs(MainHeaderButtonsWrapper,{children:[/*#__PURE__*/_jsxs(FormControl,{variant:\"outlined\",size:\"small\",className:classes.sortSelect,children:[/*#__PURE__*/_jsx(InputLabel,{htmlFor:\"sort-order-select\",children:\"Ordenar por\"}),/*#__PURE__*/_jsxs(Select,{native:true,value:sortOrder,onChange:handleSortOrderChange,label:\"Ordenar por\",inputProps:{name:'sortOrder',id:'sort-order-select'},children:[/*#__PURE__*/_jsx(\"option\",{value:\"ticketNumber\",children:\"N\\xFAmero do Ticket\"}),/*#__PURE__*/_jsx(\"option\",{value:\"lastMessageTime\",children:\"\\xDAltima Mensagem\"}),/*#__PURE__*/_jsx(\"option\",{value:\"valorDesc\",children:\"Valor (maior para menor)\"})]})]}),/*#__PURE__*/_jsx(TextField,{label:\"Data de in\\xEDcio\",type:\"date\",value:startDate,onChange:handleStartDateChange,InputLabelProps:{shrink:true},variant:\"outlined\",className:classes.dateInput,size:\"small\"}),/*#__PURE__*/_jsx(TextField,{label:\"Data de fim\",type:\"date\",value:endDate,onChange:handleEndDateChange,InputLabelProps:{shrink:true},variant:\"outlined\",className:classes.dateInput,size:\"small\"}),/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",onClick:handleSearchClick,className:classes.button,children:\"Buscar\"}),/*#__PURE__*/_jsx(Can,{role:user.profile,perform:\"dashboard:view\",yes:()=>/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",onClick:handleAddColumnClick,className:classes.button,children:\"+ Adicionar colunas\"})})]})]}),/*#__PURE__*/_jsx(Paper,{variant:\"outlined\",className:classes.mainPaper,children:/*#__PURE__*/_jsx(KanbanBoard,{lanes:lanes,onCardMove:handleCardMove,onLaneReorder:handleLaneReorder,updateTicket:updateTicket,isAdmin:user.profile==='admin'})})]});};export default Kanban;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}